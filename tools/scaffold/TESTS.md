# Scaffold CLI - Simulation & Exploratory Tests

Code generation CLI for creating concepts, orchestrators, projections, routes, and migrations. Generates compile-ready application skeleton.

## Quick Reference

```powershell
# Run all scaffold tests
go test ./tools/scaffold -v

# Run pairwise flag combination tests
go test ./tools/scaffold -v -run Pairwise

# View help
go run ./tools/scaffold init --help
```

---

## Current Test Coverage

| Test Suite | Coverage Focus |
|------------|----------------|
| `main_test.go` | Full scaffold, migrations, route regeneration, compilation |
| `pairwise_test.go` | All 512 flag combinations |

---

## Generated Artifacts

| Flag | Generated Files |
|------|-----------------|
| `--concept X` | `internal/domain/<x>/model.go`, `internal/adapters/storage/<x>/store.go`, `migrations/*_create_<x>.sql` |
| `--orchestrator X` | `internal/application/orchestrators/<x>.go` |
| `--projection X` | `internal/application/projections/<x>.go` |
| `--route METHOD:PATH:TARGET` | `internal/adapters/http/routes.go` (regenerated) |

---

## Exploratory Test Scenarios

### 1. Minimal Concept

```powershell
go run ./tools/scaffold init --root C:\temp\test --concept Order

# Generated: internal/domain/order/model.go
```

```go
package order

type Order struct {
    ID string  // Always added
}
```

**Verify**:
- ✓ `ID string` field always present
- ✓ Package name is snake_case of concept
- ✓ Storage store.go references domain model

### 2. Concept with Fields

```powershell
go run ./tools/scaffold init --root C:\temp\test `
  --concept Order `
  --field Order:Status:string `
  --field Order:TotalCents:int `
  --field Order:Completed:bool
```

```go
type Order struct {
    Completed  bool
    ID         string
    Status     string
    TotalCents int
}
```

**Verify**:
- ✓ Fields sorted alphabetically
- ✓ ID still present
- ✓ Types mapped correctly

### 3. Concept with Methods

```powershell
go run ./tools/scaffold init --root C:\temp\test `
  --concept Order `
  --method Order:Approve `
  --method Order:Cancel
```

```go
func (c *Order) Approve() {
    // TODO: describe state changes and invariants.
}

func (c *Order) Cancel() {
    // TODO: describe state changes and invariants.
}
```

### 4. Type Mapping to SQL

| Go Type | SQL Type |
|---------|----------|
| `string` | `TEXT` |
| `int`, `int32` | `INTEGER` |
| `int64` | `BIGINT` |
| `bool` | `BOOLEAN` |
| `float32` | `REAL` |
| `float64` | `DOUBLE PRECISION` |
| `time.Time` | `TIMESTAMP` |
| anything else | `TEXT` |

**Migration Test**:
```powershell
go run ./tools/scaffold init --root C:\temp\test `
  --concept Event `
  --field Event:Name:string `
  --field Event:Count:int `
  --field Event:Active:bool `
  --field Event:Timestamp:time.Time

cat C:\temp\test\internal\adapters\storage\migrations\*_create_event.sql
```

```sql
CREATE TABLE event (
  active BOOLEAN,
  count INTEGER,
  id TEXT,
  name TEXT,
  timestamp TIMESTAMP
);
```

### 5. Orchestrator Generation

```powershell
go run ./tools/scaffold init --root C:\temp\test `
  --orchestrator CreateOrder `
  --param CreateOrder:CustomerID:string `
  --param CreateOrder:Amount:int
```

**Verify** `internal/application/orchestrators/create_order.go`:
```go
package orchestrators

import "context"

type CreateOrderInput struct {
    Amount     int
    CustomerID string
}

func ExecuteCreateOrder(ctx context.Context, input CreateOrderInput) error {
    // TODO: marshal input into concept operations.
    return nil
}
```

### 6. Projection Generation

```powershell
go run ./tools/scaffold init --root C:\temp\test `
  --projection OrderSummary `
  --query OrderSummary:OrderID:string `
  --result OrderSummary:Status:string `
  --result OrderSummary:Total:int
```

**Verify** `internal/application/projections/order_summary.go`:
```go
package projections

import "context"

type OrderSummaryQuery struct {
    OrderID string
}

type OrderSummaryResult struct {
    Status string
    Total  int
}

func QueryOrderSummary(ctx context.Context, query OrderSummaryQuery) (OrderSummaryResult, error) {
    // TODO: read concept or projection state only.
    return OrderSummaryResult{}, nil
}
```

### 7. Route Generation

```powershell
go run ./tools/scaffold init --root C:\temp\test `
  --projection OrderSummary `
  --orchestrator CreateOrder `
  --route GET:/views/order-summary:OrderSummary `
  --route POST:/orders:CreateOrder
```

**Verify** `internal/adapters/http/routes.go`:
- ✓ Contains `// Code generated by scaffold; DO NOT EDIT.`
- ✓ GET handler calls `projections.QueryOrderSummary`
- ✓ POST handler calls `orchestrators.ExecuteCreateOrder`
- ✓ Handler names follow pattern: `handle<Method><Path><Target>`

### 8. Incremental Field Addition

```powershell
# Initial creation
go run ./tools/scaffold init --root C:\temp\test `
  --concept Order --field Order:Status:string

# Add new field
go run ./tools/scaffold init --root C:\temp\test `
  --concept Order --field Order:Notes:string

# Verify ALTER migration created
dir C:\temp\test\internal\adapters\storage\migrations\*_alter_order.sql
```

```sql
ALTER TABLE order ADD COLUMN notes TEXT;
```

### 9. Force Overwrite

```powershell
# Initial scaffold
go run ./tools/scaffold init --root C:\temp\test --concept Order

# Modify model.go manually
"// custom comment" | Out-File -Append C:\temp\test\internal\domain\order\model.go

# Without --force: keeps custom content
go run ./tools/scaffold init --root C:\temp\test --concept Order
# File unchanged

# With --force: overwrites
go run ./tools/scaffold init --root C:\temp\test --concept Order --force
# File regenerated without custom comment
```

### 10. State Tracking

```powershell
go run ./tools/scaffold init --root C:\temp\test `
  --concept Order --concept Customer

cat C:\temp\test\.scaffold\state.json
```

```json
{
  "version": 1,
  "concepts": {
    "Customer": { "name": "Customer", "fields": [...] },
    "Order": { "name": "Order", "fields": [...] }
  },
  "orchestrators": {},
  "projections": {},
  "routes": []
}
```

---

## Base Layout Tests

After any `scaffold init`, verify base structure exists:

```
internal/
├── domain/
│   └── README.md
├── application/
│   ├── README.md
│   ├── orchestrators/
│   └── projections/
└── adapters/
    ├── http/
    │   ├── routes.go
    │   └── web.go
    └── storage/
        └── migrations/
cmd/
└── server/
    └── main.go
go.mod
static/
.scaffold/
└── state.json
```

---

## Edge Cases

### Empty Flags

```powershell
go run ./tools/scaffold init --root C:\temp\empty
# Creates base layout only, no concepts/orchestrators/projections
```

### Duplicate Fields

```powershell
go run ./tools/scaffold init --root C:\temp\test `
  --concept Order `
  --field Order:Status:string `
  --field Order:Status:int

# Later definition wins, Status is int
```

### Snake Case Conversion

| Input | Package Name | Table Name |
|-------|--------------|------------|
| `Order` | `order` | `order` |
| `OrderItem` | `order_item` | `order_item` |
| `InventoryItem` | `inventory_item` | `inventory_item` |
| `APIKey` | `a_p_i_key` | `a_p_i_key` |

### Routes Without Targets

```powershell
go run ./tools/scaffold init --root C:\temp\test `
  --route GET:/health:HealthCheck

# Projection HealthCheck not defined - routes.go still generated
# Handler calls projections.QueryHealthCheck (compile error until projection exists)
```

---

## Compilation Verification

```powershell
# Full scaffold
go run ./tools/scaffold init --root C:\temp\compile-test `
  --module compiletest `
  --concept Order `
  --field Order:Status:string `
  --orchestrator CreateOrder `
  --param CreateOrder:CustomerID:string `
  --projection OrderSummary `
  --query OrderSummary:OrderID:string `
  --result OrderSummary:Status:string `
  --route GET:/views/order-summary:OrderSummary `
  --route POST:/orders:CreateOrder

cd C:\temp\compile-test
go build ./...
echo "Exit code: $LASTEXITCODE"
# Expected: 0
```

---

## Manual Smoke Test

```powershell
# Create complete app skeleton
$testDir = "C:\temp\scaffold-manual"
Remove-Item $testDir -Recurse -Force -ErrorAction SilentlyContinue

go run ./tools/scaffold init --root $testDir --module myapp `
  --concept User `
  --field User:Email:string `
  --field User:Active:bool `
  --method User:Deactivate `
  --concept Product `
  --field Product:Name:string `
  --field Product:PriceCents:int `
  --orchestrator RegisterUser `
  --param RegisterUser:Email:string `
  --orchestrator PurchaseProduct `
  --param PurchaseProduct:UserID:string `
  --param PurchaseProduct:ProductID:string `
  --projection UserProfile `
  --query UserProfile:UserID:string `
  --result UserProfile:Email:string `
  --result UserProfile:Active:bool `
  --route GET:/users/{id}:UserProfile `
  --route POST:/users:RegisterUser `
  --route POST:/purchases:PurchaseProduct

# Verify structure
tree $testDir /F

# Verify compilation
cd $testDir
go mod tidy
go build ./...

# Run server (should start on port 8080)
go run ./cmd/server
```

**Expected directory structure**:
```
myapp/
├── .scaffold/state.json
├── cmd/server/main.go
├── go.mod
├── internal/
│   ├── adapters/
│   │   ├── http/
│   │   │   ├── routes.go
│   │   │   └── web.go
│   │   └── storage/
│   │       ├── migrations/
│   │       │   ├── *_create_product.sql
│   │       │   └── *_create_user.sql
│   │       ├── product/store.go
│   │       └── user/store.go
│   ├── application/
│   │   ├── orchestrators/
│   │   │   ├── purchase_product.go
│   │   │   └── register_user.go
│   │   └── projections/
│   │       └── user_profile.go
│   └── domain/
│       ├── product/model.go
│       └── user/model.go
└── static/
```
