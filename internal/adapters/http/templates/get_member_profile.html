{{ define "content" }}
<div class="card">
    <h1>üë§ Member Profile</h1>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div style="background: #f8f9fa; padding: 1.25rem; border-radius:2px;">
            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Name</div>
            <div style="font-size: 1.2rem; font-weight: 600;">{{ .Name }}</div>
        </div>
        <div style="background: #f8f9fa; padding: 1.25rem; border-radius:2px;">
            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Email</div>
            <div style="font-size: 1.2rem;">{{ .Email }}</div>
        </div>
        <div style="background: #f8f9fa; padding: 1.25rem; border-radius:2px;">
            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Program</div>
            <div>
                <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: #e3f2fd; color: #1976d2;">{{ .Program }}</span>
            </div>
        </div>
        <div style="background: #f8f9fa; padding: 1.25rem; border-radius:2px;">
            <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.25rem;">Status</div>
            <div>
                {{ if eq .Status "active" }}
                <span style="color: #F9B232; font-weight: 600;">‚úì Active</span>
                {{ else }}
                <span style="color: #dc3545; font-weight: 600;">‚úó Inactive</span>
                {{ end }}
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div style="background: {{ if .HasValidWaiver }}#e8f5e9{{ else }}#fff3cd{{ end }}; padding: 1.25rem; border-radius:2px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÑ</div>
            <div style="font-weight: 600; margin-bottom: 0.25rem;">Waiver</div>
            {{ if .HasValidWaiver }}
            <span style="color: #2e7d32; font-weight: 600;">Valid</span>
            {{ else }}
            <span style="color: #856404; font-weight: 600;">Expired / Not Signed</span>
            {{ end }}
        </div>

        <div style="background: {{ if .ActiveInjuries }}#fff3cd{{ else }}#e8f5e9{{ end }}; padding: 1.25rem; border-radius:2px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üö®</div>
            <div style="font-weight: 600; margin-bottom: 0.25rem;">Injuries</div>
            {{ if .ActiveInjuries }}
                {{ range .ActiveInjuries }}
                <span style="display: inline-block; padding: 0.15rem 0.5rem; border-radius:2px; background: #ffecb3; color: #856404; font-size: 0.85rem; margin: 0.15rem;">{{ . }}</span>
                {{ end }}
            {{ else }}
            <span style="color: #2e7d32; font-weight: 600;">None</span>
            {{ end }}
        </div>

        <div style="background: #e3f2fd; padding: 1.25rem; border-radius:2px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
            <div style="font-weight: 600; margin-bottom: 0.25rem;">Attendance (30d)</div>
            <span style="font-size: 1.5rem; font-weight: 700; color: #1565c0;">{{ .RecentAttendance }}</span>
            <span style="color: #666; font-size: 0.85rem;"> sessions</span>
        </div>
    </div>

    {{ if or (eq (currentRole) "admin") (eq (currentRole) "coach") }}
    <h2 style="margin-top:2rem;">Estimated Hours</h2>
    <p style="color:#6c757d;font-size:0.85rem;margin-bottom:0.75rem;">Add estimated mat hours for periods without check-in records.</p>
    <div id="estimatedHoursList" style="margin-bottom:1rem;color:#6c757d;">Loading...</div>
    <details style="background:var(--bg,#f8f9fa);padding:1rem;border-radius:2px;">
        <summary style="cursor:pointer;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.5px;">Add Estimated Hours</summary>
        <form id="estHoursForm" style="margin-top:0.75rem;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
                <div class="form-group">
                    <label for="estStart">Start Date</label>
                    <input type="date" id="estStart" required>
                </div>
                <div class="form-group">
                    <label for="estEnd">End Date</label>
                    <input type="date" id="estEnd" required>
                </div>
            </div>
            <div class="form-group">
                <label for="estWeekly">Hours per Week</label>
                <input type="number" id="estWeekly" min="0.5" max="40" step="0.5" placeholder="e.g. 3" required>
            </div>
            <div class="form-group">
                <label for="estNote">Note (optional)</label>
                <input type="text" id="estNote" placeholder="e.g. trained at another gym" maxlength="500">
            </div>
            <button type="submit">Add Estimated Hours</button>
            <span id="estMsg" style="margin-left:0.75rem;font-size:0.85rem;"></span>
            <div id="overlapWarning" style="display:none;margin-top:0.75rem;padding:0.75rem;background:#fff3cd;border:1px solid #ffc107;border-radius:2px;">
                <strong style="color:#856404;">Overlap Detected</strong>
                <p id="overlapText" style="margin:0.5rem 0;color:#856404;font-size:0.9rem;"></p>
                <button type="button" onclick="submitEstHours('replace')" style="background:#dc3545;margin-right:0.5rem;">Replace Recorded Hours</button>
                <button type="button" onclick="document.getElementById('overlapWarning').style.display='none'" style="background:#6c757d;">Cancel</button>
            </div>
        </form>
    </details>

    <h2 style="margin-top:2rem;">Coach Observations</h2>
    <div id="observationList" style="color:#6c757d;margin-bottom:1rem;">Loading...</div>
    <div style="display:flex;gap:0.5rem;">
        <input type="text" id="obsContent" placeholder="Add observation..." maxlength="1000" style="flex:1;">
        <button onclick="addObservation()">Add</button>
    </div>
    {{ end }}

    {{ if eq (currentRole) "admin" }}
    <div style="margin-top:2rem;padding:1.5rem;background:#f8f9fa;border-radius:2px;">
        <h3 style="margin-top:0;">Admin Actions</h3>
        {{ if eq .Status "active" }}
        <button onclick="archiveMember()" style="background:#dc3545;">Archive Member</button>
        {{ else }}
        <button onclick="restoreMember()" style="background:#F9B232;">Restore Member</button>
        {{ end }}
        <span id="actionMsg" style="margin-left:1rem;color:#F9B232;"></span>
    </div>
    {{ end }}

    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #f0f0f0;">
        <a href="/members" style="color: #667eea; text-decoration: none; font-weight: 600;">‚Üê Back to Member List</a>
        <span style="margin: 0 1rem; color: #dee2e6;">|</span>
        <a href="/dashboard" style="color: #667eea; text-decoration: none; font-weight: 600;">Dashboard</a>
    </div>
</div>

<script>
var memberID = '{{ .MemberID }}';
function loadObservations() {
    fetch('/api/observations?member_id='+memberID).then(r=>r.json()).then(data => {
        var el = document.getElementById('observationList');
        if (!el) return;
        if (!data||data.length===0) { el.innerHTML='<p style="color:#6c757d;font-style:italic;">No observations yet.</p>'; return; }
        el.innerHTML='';
        data.forEach(o => {
            el.innerHTML+='<div style="background:#fff;border:1px solid #dee2e6;padding:0.75rem;border-radius:2px;margin-bottom:0.5rem;border-left:3px solid #1A1B1F;">'+
                '<p style="margin:0;">'+o.Content+'</p>'+
                '<div style="font-size:0.8rem;color:#999;margin-top:0.25rem;">'+new Date(o.CreatedAt).toLocaleDateString()+'</div></div>';
        });
    }).catch(()=>{});
}
function addObservation() {
    var content = document.getElementById('obsContent');
    if (!content || !content.value.trim()) return;
    fetch('/api/observations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({MemberID:memberID,Content:content.value})})
    .then(r=>{if(!r.ok)throw r;return r.json();})
    .then(()=>{content.value='';loadObservations();});
}
function archiveMember() {
    if (!confirm('Archive this member?')) return;
    fetch('/api/members/archive',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({MemberID:memberID})})
    .then(r=>{if(r.ok){document.getElementById('actionMsg').textContent='Archived!';setTimeout(()=>location.reload(),1000);}});
}
function restoreMember() {
    fetch('/api/members/restore',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({MemberID:memberID})})
    .then(r=>{if(r.ok){document.getElementById('actionMsg').textContent='Restored!';setTimeout(()=>location.reload(),1000);}});
}
function loadEstimatedHours() {
    var el = document.getElementById('estimatedHoursList');
    if (!el) return;
    fetch('/api/estimated-hours?member_id='+memberID).then(r=>r.json()).then(data => {
        if (!data||data.length===0) { el.innerHTML='<p style="font-style:italic;">No estimated hours recorded.</p>'; return; }
        var html='';
        data.forEach(e => {
            html+='<div style="background:#fff;border:1px solid #dee2e6;padding:0.75rem;border-radius:2px;margin-bottom:0.5rem;border-left:3px solid #F9B232;display:flex;justify-content:space-between;align-items:center;">';
            html+='<div><strong>'+e.StartDate+' ‚Üí '+e.EndDate+'</strong>';
            html+=' ¬∑ '+e.WeeklyHours+'h/week ¬∑ <strong>'+e.TotalHours+'h total</strong>';
            if(e.Note){html+=' ¬∑ <span style="color:#999;">'+e.Note+'</span>';}
            html+='<div style="font-size:0.8rem;color:#999;margin-top:0.2rem;">'+e.Source+' ¬∑ '+e.Status+'</div>';
            html+='</div>';
            html+='<button onclick="deleteEstHours(\''+e.ID+'\')" style="background:#dc3545;color:#fff;border:none;padding:0.25rem 0.5rem;font-size:0.75rem;cursor:pointer;border-radius:2px;" title="Delete">‚úï</button>';
            html+='</div>';
        });
        el.innerHTML=html;
    }).catch(()=>{ el.innerHTML='<p style="color:#dc3545;">Failed to load.</p>'; });
}
function deleteEstHours(id) {
    if (!confirm('Delete this estimated hours entry?')) return;
    fetch('/api/estimated-hours?id='+id,{method:'DELETE'}).then(r=>{if(r.ok)loadEstimatedHours();});
}
function getEstFormData() {
    return {
        MemberID:memberID,
        StartDate:document.getElementById('estStart').value,
        EndDate:document.getElementById('estEnd').value,
        WeeklyHours:parseFloat(document.getElementById('estWeekly').value),
        Note:document.getElementById('estNote').value
    };
}
function submitEstHours(overlapMode) {
    var msg = document.getElementById('estMsg');
    var data = getEstFormData();
    if (overlapMode) data.OverlapMode = overlapMode;
    msg.textContent='Saving...';msg.style.color='#666';
    document.getElementById('overlapWarning').style.display='none';
    fetch('/api/estimated-hours',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(r=>{
        if(!r.ok) return r.text().then(t=>{throw new Error(t);});
        return r.json();
    }).then(e=>{
        msg.textContent='Added '+e.TotalHours+'h!';msg.style.color='#2e7d32';
        document.getElementById('estHoursForm').reset();loadEstimatedHours();
    }).catch(err=>{msg.textContent='Error: '+err.message;msg.style.color='#dc3545';});
}
var estForm = document.getElementById('estHoursForm');
if (estForm) {
    estForm.addEventListener('submit', function(ev) {
        ev.preventDefault();
        var msg = document.getElementById('estMsg');
        var data = getEstFormData();
        if (!data.StartDate||!data.EndDate||!data.WeeklyHours) { msg.textContent='Fill all required fields';msg.style.color='#dc3545'; return; }
        msg.textContent='Checking for overlaps...';msg.style.color='#666';
        fetch('/api/estimated-hours/check-overlap?member_id='+memberID+'&start_date='+data.StartDate+'&end_date='+data.EndDate)
        .then(r=>r.json()).then(result=>{
            if (result.HasOverlap) {
                msg.textContent='';
                var warn = document.getElementById('overlapWarning');
                document.getElementById('overlapText').textContent=result.OverlapSummary+'. Choose an action:';
                warn.style.display='block';
            } else {
                submitEstHours('');
            }
        }).catch(err=>{msg.textContent='Error: '+err.message;msg.style.color='#dc3545';});
    });
    loadEstimatedHours();
}
if (document.getElementById('observationList')) loadObservations();
</script>
{{ end }}