{{ define "content" }}
<div class="card">
    <h1>Grading Management</h1>

    <h2>Pending Proposals</h2>
    <div id="proposalList" style="color:#6c757d;">Loading...</div>

    <h2 style="margin-top:2rem;">Grading Readiness</h2>
    <div id="readinessList" style="color:#6c757d;">Loading...</div>

    <h2 style="margin-top:2rem;">Grading Config</h2>
    <div style="background:#f8f9fa;padding:1.5rem;border-radius:2px;margin-bottom:1rem;">
        <h3 style="margin-top:0;">Add Config</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:1rem;">
            <div class="form-group">
                <label>Program</label>
                <select id="cfgProgram" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
                    <option value="adults">Adults</option>
                    <option value="kids">Kids</option>
                </select>
            </div>
            <div class="form-group">
                <label>Belt</label>
                <select id="cfgBelt" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
                    <option value="white">White</option>
                    <option value="blue" selected>Blue</option>
                    <option value="purple">Purple</option>
                    <option value="brown">Brown</option>
                    <option value="black">Black</option>
                    <option value="grey">Grey</option>
                    <option value="yellow">Yellow</option>
                    <option value="orange">Orange</option>
                    <option value="green">Green</option>
                </select>
            </div>
            <div class="form-group">
                <label>Flight Time (hrs)</label>
                <input type="number" id="cfgHours" placeholder="150">
            </div>
            <div class="form-group">
                <label>Stripes</label>
                <input type="number" id="cfgStripes" placeholder="4">
            </div>
        </div>
        <button onclick="createConfig()">Add Config</button>
        <span id="cfgMsg" style="margin-left:1rem;color:#F9B232;"></span>
    </div>
    <div id="configList" style="color:#6c757d;">Loading...</div>

    <p style="margin-top:2rem;"><a href="/dashboard" style="color:#F9B232;text-decoration:none;font-weight:600;">← Back to Dashboard</a></p>
</div>

<script>
var memberNames = {};
function loadMemberNames() {
    return fetch('/api/members?limit=500').then(r=>r.json()).then(data => {
        if (data && data.Members) data.Members.forEach(m => { memberNames[m.ID] = m.Name; });
        else if (Array.isArray(data)) data.forEach(m => { memberNames[m.ID] = m.Name; });
    }).catch(()=>{});
}
function memberName(id) { return memberNames[id] || id.substring(0,8)+'...'; }
function loadProposals() {
    fetch('/api/grading/proposals').then(r=>r.json()).then(data => {
        var el = document.getElementById('proposalList');
        if (!data||data.length===0) { el.innerHTML='<p style="color:#6c757d;font-style:italic;">No pending proposals.</p>'; return; }
        el.innerHTML='';
        data.forEach(p => {
            var isPending = p.Status==='pending';
            el.innerHTML+='<div style="background:#fff;border:1px solid #dee2e6;padding:1rem;border-radius:2px;margin-bottom:0.5rem;display:flex;justify-content:space-between;align-items:center;">'+
                '<div><strong>'+memberName(p.MemberID)+'</strong> → '+p.TargetBelt+' <span style="font-size:0.8rem;color:#999;">('+p.Status+')</span></div>'+
                (isPending?'<div><button onclick="decide(\''+p.ID+'\',\'approve\')" style="background:#F9B232;padding:0.25rem 0.75rem;font-size:0.85rem;margin-right:0.5rem;">Approve</button><button onclick="decide(\''+p.ID+'\',\'reject\')" style="background:#dc3545;padding:0.25rem 0.75rem;font-size:0.85rem;">Reject</button></div>':'')+
                '</div>';
        });
    });
}
function decide(id,decision) {
    fetch('/api/grading/proposals/decide',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ProposalID:id,Decision:decision})})
    .then(()=>loadProposals());
}
function loadReadiness() {
    var thStyle='padding:0.5rem;text-align:left;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);';
    fetch('/api/grading/readiness').then(r=>r.json()).then(data => {
        var el = document.getElementById('readinessList');
        var html='';

        // Adults section
        if (data.Adults && data.Adults.length>0) {
            html+='<h3 style="margin-top:0;">Adults (Mat Hours)</h3>';
            html+='<table style="width:100%;border-collapse:collapse;"><thead><tr style="border-bottom:2px solid var(--border);">';
            html+='<th style="'+thStyle+'">Member</th><th style="'+thStyle+'">Belt</th><th style="'+thStyle+'">Hours</th><th style="'+thStyle+'">Progress</th><th style="'+thStyle+'">Action</th>';
            html+='</tr></thead><tbody>';
            data.Adults.forEach(m => {
                var isKidsHours = m.Program==='kids';
                html+='<tr style="border-bottom:1px solid var(--border);">';
                html+='<td style="padding:0.5rem;font-weight:600;">'+m.MemberName+(isKidsHours?' <span style="font-size:0.7rem;color:#6c757d;">(kids/hours)</span>':'')+'</td>';
                html+='<td style="padding:0.5rem;">'+m.CurrentBelt+' → '+m.TargetBelt+'</td>';
                html+='<td style="padding:0.5rem;">'+m.MatHours.toFixed(1)+'h / '+m.RequiredHours+'h</td>';
                html+='<td style="padding:0.5rem;">'+m.PercentReady.toFixed(0)+'%'+(isKidsHours?' <button onclick="toggleMetric(\''+m.MemberID+'\',\'sessions\')" style="background:none;border:1px solid #6c757d;padding:0.1rem 0.4rem;border-radius:2px;font-size:0.7rem;cursor:pointer;margin-left:0.5rem;" title="Switch back to session-based grading">→ Sessions</button>':'')+'</td>';
                html+='<td style="padding:0.5rem;"><button onclick="proposePromotion(\''+m.MemberID+'\',\''+m.TargetBelt+'\')" style="background:#F9B232;color:#fff;border:none;padding:0.25rem 0.75rem;border-radius:2px;font-size:0.8rem;cursor:pointer;">Propose</button></td>';
                html+='</tr>';
            });
            html+='</tbody></table>';
        } else {
            html+='<h3 style="margin-top:0;">Adults (Mat Hours)</h3>';
            html+='<p style="color:#6c757d;font-style:italic;">No adults approaching eligibility.</p>';
        }

        // Kids section
        var termLabel = data.TermName ? ' — '+data.TermName : '';
        html+='<h3 style="margin-top:1.5rem;">Kids (Term Attendance'+termLabel+')</h3>';
        if (data.Kids && data.Kids.length>0) {
            html+='<table style="width:100%;border-collapse:collapse;"><thead><tr style="border-bottom:2px solid var(--border);">';
            html+='<th style="'+thStyle+'">Member</th><th style="'+thStyle+'">Belt</th><th style="'+thStyle+'">Sessions</th><th style="'+thStyle+'">Attendance</th><th style="'+thStyle+'">Status</th><th style="'+thStyle+'">Action</th>';
            html+='</tr></thead><tbody>';
            data.Kids.forEach(k => {
                var statusBadge = k.Eligible
                    ? '<span style="background:#28a745;color:#fff;padding:0.15rem 0.5rem;border-radius:2px;font-size:0.8rem;">Eligible</span>'
                    : '<span style="color:#6c757d;font-size:0.8rem;">'+k.AttendancePct.toFixed(0)+'% (need '+k.ThresholdPct+'%)</span>';
                html+='<tr style="border-bottom:1px solid var(--border);">';
                html+='<td style="padding:0.5rem;font-weight:600;">'+k.MemberName+'</td>';
                html+='<td style="padding:0.5rem;">'+k.CurrentBelt+' → '+k.TargetBelt+'</td>';
                html+='<td style="padding:0.5rem;">'+k.Attended+' / '+k.TotalSessions+'</td>';
                html+='<td style="padding:0.5rem;">'+k.AttendancePct.toFixed(0)+'%</td>';
                html+='<td style="padding:0.5rem;">'+statusBadge+'</td>';
                var actionHtml = '';
                if (k.Eligible) actionHtml += '<button onclick="proposePromotion(\''+k.MemberID+'\',\''+k.TargetBelt+'\')" style="background:#F9B232;color:#fff;border:none;padding:0.25rem 0.75rem;border-radius:2px;font-size:0.8rem;cursor:pointer;margin-right:0.25rem;">Propose</button>';
                actionHtml += '<button onclick="toggleMetric(\''+k.MemberID+'\',\'hours\')" style="background:none;border:1px solid #6c757d;padding:0.15rem 0.5rem;border-radius:2px;font-size:0.75rem;cursor:pointer;" title="Switch to hours-based grading">→ Hours</button>';
                html+='<td style="padding:0.5rem;">'+actionHtml+'</td>';
                html+='</tr>';
            });
            html+='</tbody></table>';
        } else {
            html+='<p style="color:#6c757d;font-style:italic;">No kids data for current term.</p>';
        }

        el.innerHTML=html;
    }).catch(()=>{document.getElementById('readinessList').innerHTML='<p style="color:#6c757d;font-style:italic;">Could not load readiness data.</p>';});
}
function loadConfigs() {
    fetch('/api/grading/config').then(r=>r.json()).then(data => {
        var el = document.getElementById('configList');
        if (!data||data.length===0) { el.innerHTML='<p style="color:#6c757d;font-style:italic;">No configs.</p>'; return; }
        var html='<table style="width:100%;border-collapse:collapse;"><thead><tr style="border-bottom:2px solid var(--border);"><th style="padding:0.5rem;text-align:left;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);">Program</th><th style="padding:0.5rem;text-align:left;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);">Belt</th><th style="padding:0.5rem;text-align:left;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);">Flight Time</th><th style="padding:0.5rem;text-align:left;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);">Stripes</th></tr></thead><tbody>';
        data.forEach(c => {
            html+='<tr style="border-bottom:1px solid var(--border);"><td style="padding:0.5rem;">'+c.Program+'</td><td style="padding:0.5rem;font-weight:600;">'+c.Belt+'</td><td style="padding:0.5rem;">'+c.FlightTimeHours+'h</td><td style="padding:0.5rem;">'+c.StripeCount+'</td></tr>';
        });
        html+='</tbody></table>';
        el.innerHTML=html;
    });
}
function createConfig() {
    fetch('/api/grading/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        Program:document.getElementById('cfgProgram').value,
        Belt:document.getElementById('cfgBelt').value,
        FlightTimeHours:parseInt(document.getElementById('cfgHours').value)||0,
        AttendancePct:0,
        StripeCount:parseInt(document.getElementById('cfgStripes').value)||4
    })}).then(r=>{if(!r.ok)throw r;return r.json();})
    .then(()=>{document.getElementById('cfgMsg').textContent='Created!';loadConfigs();setTimeout(()=>document.getElementById('cfgMsg').textContent='',2000);})
    .catch(r=>{if(r&&r.text)r.text().then(t=>document.getElementById('cfgMsg').textContent=t||'Error');else document.getElementById('cfgMsg').textContent='Error';});
}
function proposePromotion(memberID, targetBelt) {
    if (!confirm('Propose promotion to ' + targetBelt + '?')) return;
    fetch('/api/grading/proposals',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({MemberID:memberID,TargetBelt:targetBelt,Notes:'Proposed from readiness list'})})
    .then(r=>{if(!r.ok)throw r;document.getElementById('cfgMsg').textContent='Proposal created!';document.getElementById('cfgMsg').style.color='#2e7d32';setTimeout(()=>document.getElementById('cfgMsg').textContent='',3000);loadProposals();})
    .catch(()=>{document.getElementById('cfgMsg').textContent='Failed to create proposal';document.getElementById('cfgMsg').style.color='#dc3545';setTimeout(()=>document.getElementById('cfgMsg').textContent='',3000);});
}
function toggleMetric(memberID, metric) {
    fetch('/api/grading/metric',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({MemberID:memberID,Metric:metric})})
    .then(r=>{if(!r.ok)throw r;loadReadiness();})
    .catch(()=>{alert('Failed to toggle metric');});
}
loadMemberNames().then(function(){ loadProposals(); loadReadiness(); });
loadConfigs();
</script>
{{ end }}
