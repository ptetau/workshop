{{ define "content" }}
<div class="card">
    <h1>My Training Log</h1>

    <div id="beltSection" style="display:none;margin:1rem 0;">
        <div style="display:flex;align-items:center;gap:0.5rem;">
            <span id="beltIcon" style="display:inline-block;width:22px;height:12px;border-radius:2px;border:1px solid #ccc;"></span>
            <span id="beltName" style="font-weight:600;text-transform:capitalize;"></span>
            <span id="beltStripes"></span>
        </div>
    </div>

    <div id="stats" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin:1.5rem 0;">
        <div style="background:#e8f5e9;padding:1.25rem;border-radius:2px;text-align:center;">
            <div id="totalClasses" style="font-size:1.75rem;font-weight:bold;color:#2e7d32;">0</div>
            <div style="color:#666;margin-top:0.25rem;">Classes</div>
        </div>
        <div style="background:#e3f2fd;padding:1.25rem;border-radius:2px;text-align:center;">
            <div id="matHours" style="font-size:1.75rem;font-weight:bold;color:#1565c0;">0h</div>
            <div id="hoursSplit" style="color:#999;font-size:0.75rem;margin-top:0.15rem;"></div>
            <div style="color:#666;margin-top:0.25rem;">Flight Time</div>
        </div>
        <div style="background:#fff3e0;padding:1.25rem;border-radius:2px;text-align:center;">
            <div id="streak" style="font-size:1.75rem;font-weight:bold;color:#e65100;">0w</div>
            <div style="color:#666;margin-top:0.25rem;">Week Streak</div>
        </div>
    </div>

    <div id="progressSection" style="display:none;margin:0 0 1.5rem;">
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:0.35rem;">
            <span style="font-weight:600;font-size:0.9rem;">Progress toward <span id="nextBeltName" style="text-transform:capitalize;"></span></span>
            <span id="progressLabel" style="font-size:0.85rem;color:#666;"></span>
        </div>
        <div style="background:#e0e0e0;border-radius:4px;height:12px;overflow:hidden;">
            <div id="progressBar" style="height:100%;border-radius:4px;background:linear-gradient(90deg,#F9B232,#e65100);transition:width 0.5s;width:0%;"></div>
        </div>
    </div>

    <h2 style="margin-top:2rem;">Training Volume</h2>
    <div style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap;margin:0.5rem 0 0.75rem;">
        <label style="margin:0;font-size:0.85rem;color:#666;">Range</label>
        <select id="volumeRange" style="min-width:180px;" onchange="loadTrainingVolume()">
            <option value="month">Current month</option>
            <option value="year">Current year</option>
        </select>
        <label style="margin:0;display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;color:#666;cursor:pointer;">
            <input type="checkbox" id="volumeCompare" onchange="loadTrainingVolume()">
            Compare (last month + same month last year)
        </label>
        <span id="volumeMeta" style="font-size:0.8rem;color:#999;"></span>
    </div>
    <div id="volumeGraph" style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:0.75rem;">
        <div id="volumeGraphInner" style="width:100%;overflow-x:auto;"></div>
        <div id="volumeLegend" style="display:flex;flex-wrap:wrap;gap:0.75rem;margin-top:0.5rem;font-size:0.8rem;color:#666;"></div>
    </div>

    <div id="gradingNote" style="display:none;margin:0 0 1.5rem;padding:0.75rem 1rem;background:#f8f9fa;border-left:3px solid #F9B232;font-size:0.85rem;color:#666;">
        Belt progression requires minimum mat hours. Exceptions may apply for active competitors at Admin's discretion.
    </div>

    <div id="badgesSection" style="display:none;margin-bottom:1.5rem;">
        <h2 style="margin-top:0;">Earned Badges</h2>
        <div id="badgesList" style="display:flex;flex-wrap:wrap;gap:0.75rem;"></div>
    </div>

    <div id="milestoneToast" style="display:none;position:fixed;top:1.5rem;right:1.5rem;background:#2e7d32;color:#fff;padding:1rem 1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:1000;font-weight:600;max-width:350px;"></div>

    <h2>Training Goal</h2>
    <div id="goalSection">
        <div id="currentGoal" style="display:none;background:#f3e5f5;padding:1rem;border-radius:2px;margin-bottom:1rem;">
            <strong>Current Goal:</strong> <span id="goalText"></span>
        </div>
        <div style="display:flex;align-items:center;gap:1rem;">
            <label style="margin:0;">Sessions per week:</label>
            <input type="number" id="goalTarget" value="3" style="width:80px;">
            <button onclick="setGoal()">Set Goal</button>
            <span id="goalMsg" style="color:#F9B232;"></span>
        </div>
    </div>

    <h2 style="margin-top:2rem;">Submit Estimated Hours</h2>
    <p style="color:#6c757d;font-size:0.85rem;margin-bottom:0.75rem;">Trained elsewhere while travelling? Submit an estimate for review.</p>
    <div id="selfEstList" style="margin-bottom:1rem;color:#6c757d;"></div>
    <details style="background:var(--bg,#f8f9fa);padding:1rem;border-radius:2px;">
        <summary style="cursor:pointer;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.5px;">New Estimate</summary>
        <form id="selfEstForm" style="margin-top:0.75rem;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
                <div class="form-group">
                    <label for="seStart">Start Date</label>
                    <input type="date" id="seStart" required>
                </div>
                <div class="form-group">
                    <label for="seEnd">End Date</label>
                    <input type="date" id="seEnd" required>
                </div>
            </div>
            <div class="form-group" style="margin-top:0.75rem;">
                <label for="seWeekly">Hours per Week</label>
                <input type="number" id="seWeekly" min="0.5" max="40" step="0.5" value="3" required style="width:100px;">
            </div>
            <div class="form-group" style="margin-top:0.75rem;">
                <label for="seNote">Note (e.g. where you trained)</label>
                <input type="text" id="seNote" placeholder="e.g. Trained at Checkmat SP while travelling" maxlength="500">
            </div>
            <button type="submit">Submit for Review</button>
            <span id="seMsg" style="margin-left:0.75rem;font-size:0.85rem;"></span>
        </form>
    </details>

    <h2 style="margin-top:2rem;">Recent Attendance</h2>
    <div id="attendanceList" style="color:#6c757d;"><p style="font-style:italic;">No recent sessions. Check in at the kiosk to start tracking your training!</p></div>

    <p style="margin-top:2rem;"><a href="/dashboard" style="color:#F9B232;text-decoration:none;font-weight:600;">‚Üê Back to Dashboard</a></p>
</div>

<script>
var memberID = '{{ .MemberID }}';
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
var beltColors = {white:'#fff',blue:'#1565c0',purple:'#7b1fa2',brown:'#5d4037',black:'#212121',yellow:'linear-gradient(to bottom,#f9a825 35%,#fff 35%,#fff 65%,#f9a825 65%)',orange:'linear-gradient(to bottom,#e65100 35%,#fff 35%,#fff 65%,#e65100 65%)',green:'linear-gradient(to bottom,#2e7d32 35%,#fff 35%,#fff 65%,#2e7d32 65%)',grey:'linear-gradient(to bottom,#9e9e9e 35%,#fff 35%,#fff 65%,#9e9e9e 65%)'};

var volumeColors = ['#1565c0', '#2e7d32', '#e65100', '#7b1fa2'];

function loadTrainingVolume() {
    var rangeEl = document.getElementById('volumeRange');
    var cmpEl = document.getElementById('volumeCompare');
    var meta = document.getElementById('volumeMeta');
    if (!rangeEl || !cmpEl) return;

    var rng = rangeEl.value || 'month';
    // Compare is only defined for month in #293 acceptance criteria.
    if (rng !== 'month') {
        cmpEl.checked = false;
        cmpEl.disabled = true;
    } else {
        cmpEl.disabled = false;
    }
    var compare = !!cmpEl.checked;

    var url = '/api/training-volume?range=' + encodeURIComponent(rng) + '&compare=' + (compare ? 'true' : 'false');
    if (memberID) url += '&member_id=' + encodeURIComponent(memberID);

    if (meta) meta.textContent = 'Loading‚Ä¶';
    fetch(url).then(r => {
        if (!r.ok) return r.text().then(t => { throw new Error(t); });
        return r.json();
    }).then(drawTrainingVolumeGraph).catch(err => {
        if (meta) meta.textContent = 'Could not load';
        var inner = document.getElementById('volumeGraphInner');
        if (inner) inner.innerHTML = '<p style="margin:0;color:#6c757d;font-style:italic;">Could not load training volume.</p>';
    });
}

function drawTrainingVolumeGraph(data) {
    var inner = document.getElementById('volumeGraphInner');
    var legend = document.getElementById('volumeLegend');
    var meta = document.getElementById('volumeMeta');
    if (!inner || !data) return;

    var buckets = data.Buckets || [];
    var series = data.Series || [];
    if (meta) {
        meta.textContent = (data.StartDate && data.EndDate) ? (data.StartDate + ' ‚Üí ' + data.EndDate) : '';
    }
    if (buckets.length === 0 || series.length === 0) {
        inner.innerHTML = '<p style="margin:0;color:#6c757d;font-style:italic;">No data yet.</p>';
        if (legend) legend.innerHTML = '';
        return;
    }

    var maxV = 0;
    series.forEach(function(s) {
        (s.Values || []).forEach(function(v) { if (v > maxV) maxV = v; });
    });
    if (maxV <= 0) maxV = 1;

    var w = Math.max(600, buckets.length * 18);
    var h = 220;
    var padL = 36, padR = 12, padT = 12, padB = 36;
    var plotW = w - padL - padR;
    var plotH = h - padT - padB;

    function x(i) {
        if (buckets.length === 1) return padL + plotW / 2;
        return padL + (i / (buckets.length - 1)) * plotW;
    }
    function y(v) {
        return padT + (1 - (v / maxV)) * plotH;
    }
    function points(vals) {
        var p = [];
        for (var i = 0; i < buckets.length; i++) {
            var v = (vals && typeof vals[i] !== 'undefined') ? vals[i] : 0;
            p.push(x(i).toFixed(1) + ',' + y(v).toFixed(1));
        }
        return p.join(' ');
    }

    // Grid lines (0%, 50%, 100%).
    var grid = '';
    [0, 0.5, 1].forEach(function(pct) {
        var yy = padT + (1 - pct) * plotH;
        grid += '<line x1="' + padL + '" y1="' + yy.toFixed(1) + '" x2="' + (padL + plotW) + '" y2="' + yy.toFixed(1) + '" stroke="#e5e7eb" stroke-width="1" />';
        var labelV = (pct * maxV).toFixed(0);
        grid += '<text x="' + (padL - 6) + '" y="' + (yy + 4).toFixed(1) + '" text-anchor="end" font-size="10" fill="#999">' + labelV + '</text>';
    });

    var xLabels = '';
    var step = data.Range === 'year' ? 1 : Math.ceil(buckets.length / 8);
    for (var i = 0; i < buckets.length; i += step) {
        xLabels += '<text x="' + x(i).toFixed(1) + '" y="' + (padT + plotH + 18) + '" text-anchor="middle" font-size="10" fill="#999">' + esc(buckets[i]) + '</text>';
    }

    var lines = '';
    series.forEach(function(s, idx) {
        var color = volumeColors[idx % volumeColors.length];
        lines += '<polyline fill="none" stroke="' + color + '" stroke-width="2" points="' + points(s.Values || []) + '" />';
    });

    var svg = '';
    svg += '<svg width="' + w + '" height="' + h + '" viewBox="0 0 ' + w + ' ' + h + '" role="img" aria-label="Training volume">';
    svg += '<rect x="0" y="0" width="' + w + '" height="' + h + '" rx="8" ry="8" fill="#f8f9fa" />';
    svg += grid;
    svg += '<line x1="' + padL + '" y1="' + (padT + plotH) + '" x2="' + (padL + plotW) + '" y2="' + (padT + plotH) + '" stroke="#cbd5e1" stroke-width="1" />';
    svg += '<line x1="' + padL + '" y1="' + padT + '" x2="' + padL + '" y2="' + (padT + plotH) + '" stroke="#cbd5e1" stroke-width="1" />';
    svg += xLabels;
    svg += lines;
    svg += '</svg>';

    inner.innerHTML = svg;

    if (legend) {
        var html = '';
        series.forEach(function(s, idx) {
            var color = volumeColors[idx % volumeColors.length];
            html += '<span style="display:inline-flex;align-items:center;gap:0.35rem;">' +
                '<span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:' + color + ';"></span>' +
                '<span>' + esc(s.Name || ('Series ' + (idx+1))) + '</span></span>';
        });
        html += '<span style="color:#999;">(Avg line is aggregate-only; no individual attendance is revealed.)</span>';
        legend.innerHTML = html;
    }
}
function loadTrainingLog() {
    if (!memberID) return;
    fetch('/api/training-log?member_id='+memberID).then(r=>r.json()).then(data => {
        document.getElementById('totalClasses').textContent = data.TotalClasses || 0;
        document.getElementById('matHours').textContent = Math.round(data.TotalMatHours || 0) + 'h';
        document.getElementById('streak').textContent = (data.CurrentStreak || 0) + 'w';

        // Recorded vs estimated hours split
        var rec = Math.round(data.RecordedHours || 0);
        var est = Math.round(data.EstimatedHours || 0);
        var bulk = Math.round(data.BulkEstimatedHours || 0);
        var parts = [];
        if (rec > 0) parts.push(rec + 'h recorded');
        if (est > 0) parts.push(est + 'h session est.');
        if (bulk > 0) parts.push(bulk + 'h bulk est.');
        if (parts.length > 0) {
            document.getElementById('hoursSplit').textContent = parts.join(' + ');
        }

        // Belt display
        if (data.Belt) {
            document.getElementById('beltSection').style.display = 'block';
            var beltBorders = {white:'#ccc',blue:'#1565c0',purple:'#7b1fa2',brown:'#5d4037',black:'#212121',yellow:'#f9a825',orange:'#e65100',green:'#2e7d32',grey:'#9e9e9e'};
            document.getElementById('beltIcon').style.background = beltColors[data.Belt] || '#ccc';
            document.getElementById('beltIcon').style.borderColor = beltBorders[data.Belt] || '#ccc';
            document.getElementById('beltName').textContent = data.Belt;
            var stripeHtml = '';
            for (var i = 0; i < (data.Stripe || 0); i++) {
                stripeHtml += '<span style="display:inline-block;width:6px;height:6px;background:#fff;border:1px solid #999;border-radius:50%;margin-left:2px;vertical-align:middle;"></span>';
            }
            document.getElementById('beltStripes').innerHTML = stripeHtml;
        }

        // Progress bar toward next belt
        if (data.GradingMetric === 'sessions' && data.TermTotal > 0) {
            // Kids sessions mode: show term attendance progress
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('nextBeltName').textContent = data.NextBelt || 'next belt';
            var pct = Math.min(data.TermAttendancePct || 0, 100);
            document.getElementById('progressBar').style.width = pct.toFixed(0) + '%';
            document.getElementById('progressBar').style.background = data.TermEligible
                ? 'linear-gradient(90deg,#2e7d32,#43a047)'
                : 'linear-gradient(90deg,#F9B232,#e65100)';
            var label = (data.TermAttended||0) + ' / ' + data.TermTotal + ' sessions';
            if (data.TermName) label += ' (' + data.TermName + ')';
            label += ' ‚Äî ' + Math.round(pct) + '%';
            if (data.TermEligible) label += ' ‚úì eligible';
            document.getElementById('progressLabel').textContent = label;
        } else if (data.NextBelt && data.RequiredHours > 0) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('nextBeltName').textContent = data.NextBelt;
            document.getElementById('progressBar').style.width = Math.min(data.ProgressPct || 0, 100).toFixed(0) + '%';
            document.getElementById('progressLabel').textContent = Math.round(data.TotalMatHours || 0) + ' / ' + Math.round(data.RequiredHours) + 'h (' + Math.round(data.ProgressPct || 0) + '%)';
        }

        // Show grading note when progress is displayed
        if (data.Belt && data.NextBelt) {
            document.getElementById('gradingNote').style.display = 'block';
        }

        var el = document.getElementById('attendanceList');
        if (!data.Entries || data.Entries.length === 0) {
            el.innerHTML = '<p style="color:#6c757d;font-style:italic;">No recent sessions.</p>';
            return;
        }
        var recent = data.Entries.slice(0, 20);
        var html = '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#f8f9fa;border-bottom:2px solid #dee2e6;"><th style="padding:0.5rem;text-align:left;">Date</th><th style="padding:0.5rem;text-align:left;">Time</th><th style="padding:0.5rem;text-align:left;">Hours</th></tr></thead><tbody>';
        recent.forEach(s => {
            html += '<tr style="border-bottom:1px solid #dee2e6;"><td style="padding:0.5rem;">'+esc(s.Date)+'</td><td style="padding:0.5rem;">'+esc(s.CheckIn)+(s.CheckOut?' ‚Äì '+esc(s.CheckOut):'')+'</td><td style="padding:0.5rem;">'+s.DurationH.toFixed(1)+'h</td></tr>';
        });
        html += '</tbody></table>';
        el.innerHTML = html;
    }).catch(() => {
        document.getElementById('attendanceList').innerHTML = '<p style="color:#6c757d;font-style:italic;">Could not load training log.</p>';
    });
}
function loadGoal() {
    if (!memberID) return;
    fetch('/api/training-goals?member_id='+memberID).then(r=>r.json()).then(data => {
        if (data && data.ID) {
            document.getElementById('currentGoal').style.display = 'block';
            document.getElementById('goalText').textContent = data.Target + 'x ' + data.Period;
            document.getElementById('goalTarget').value = data.Target;
        }
    }).catch(() => {});
}
function setGoal() {
    if (!memberID) return;
    fetch('/api/training-goals',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        MemberID: memberID,
        Target: parseInt(document.getElementById('goalTarget').value) || 3,
        Period: 'weekly'
    })}).then(r=>{if(!r.ok)throw r;return r.json();})
    .then(() => {
        document.getElementById('goalMsg').textContent = 'Goal set!';
        loadGoal();
        setTimeout(() => document.getElementById('goalMsg').textContent = '', 2000);
    }).catch(() => document.getElementById('goalMsg').textContent = 'Error');
}
function loadMilestones() {
    if (!memberID) return;
    fetch('/api/member-milestones?member_id='+memberID).then(r=>r.json()).then(data => {
        if (!data || data.length === 0) return;
        document.getElementById('badgesSection').style.display = 'block';
        var html = '';
        data.forEach(function(item) {
            var icon = item.Milestone.BadgeIcon || 'üèÖ';
            html += '<div style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:0.75rem 1rem;text-align:center;min-width:100px;">';
            html += '<div style="font-size:2rem;">'+icon+'</div>';
            html += '<div style="font-weight:600;font-size:0.85rem;">'+esc(item.Milestone.Name)+'</div>';
            html += '</div>';
            // Show toast for unnotified milestones
            if (!item.Notified) {
                var toast = document.getElementById('milestoneToast');
                toast.textContent = icon + ' Congratulations! You earned: ' + item.Milestone.Name;
                toast.style.display = 'block';
                setTimeout(function(){ toast.style.display = 'none'; }, 5000);
            }
        });
        document.getElementById('badgesList').innerHTML = html;
    }).catch(function(){});
}
function loadSelfEstimates() {
    if (!memberID) return;
    fetch('/api/estimated-hours?member_id='+memberID).then(r=>r.json()).then(data => {
        var el = document.getElementById('selfEstList');
        // Filter to self_estimate source only
        var selfEsts = (data||[]).filter(function(e){ return e.Source === 'self_estimate'; });
        if (selfEsts.length === 0) { el.innerHTML = ''; return; }
        var html = '';
        selfEsts.forEach(function(e) {
            var statusColor = e.Status === 'approved' ? '#2e7d32' : e.Status === 'rejected' ? '#dc3545' : '#F9B232';
            var borderColor = e.Status === 'approved' ? '#2e7d32' : e.Status === 'rejected' ? '#dc3545' : '#F9B232';
            html += '<div style="background:#fff;border:1px solid #dee2e6;padding:0.75rem;border-radius:2px;margin-bottom:0.5rem;border-left:3px solid '+borderColor+';">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
            html += '<div><strong>'+esc(e.StartDate)+' to '+esc(e.EndDate)+'</strong> ‚Äî '+e.WeeklyHours+'h/wk = '+e.TotalHours+'h total</div>';
            html += '<span style="font-size:0.8rem;font-weight:600;color:'+statusColor+';text-transform:uppercase;">'+esc(e.Status)+'</span>';
            html += '</div>';
            if (e.Note) html += '<div style="color:#666;font-size:0.85rem;margin-top:0.25rem;">'+esc(e.Note)+'</div>';
            if (e.ReviewNote) html += '<div style="color:#666;font-size:0.85rem;margin-top:0.25rem;font-style:italic;">Review: '+esc(e.ReviewNote)+'</div>';
            html += '</div>';
        });
        el.innerHTML = html;
    }).catch(function(){});
}
var seForm = document.getElementById('selfEstForm');
if (seForm) {
    seForm.addEventListener('submit', function(ev) {
        ev.preventDefault();
        var msg = document.getElementById('seMsg');
        var data = {
            StartDate: document.getElementById('seStart').value,
            EndDate: document.getElementById('seEnd').value,
            WeeklyHours: parseFloat(document.getElementById('seWeekly').value) || 0,
            Note: document.getElementById('seNote').value
        };
        if (!data.StartDate || !data.EndDate || !data.WeeklyHours) {
            msg.textContent = 'Fill all required fields'; msg.style.color = '#dc3545'; return;
        }
        msg.textContent = 'Submitting...'; msg.style.color = '#666';
        fetch('/api/self-estimates', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
        .then(function(r) { if (!r.ok) return r.text().then(function(t){ throw new Error(t); }); return r.json(); })
        .then(function(e) {
            msg.textContent = 'Submitted '+e.TotalHours+'h for review!'; msg.style.color = '#2e7d32';
            seForm.reset(); loadSelfEstimates();
        }).catch(function(err) { msg.textContent = 'Error: '+err.message; msg.style.color = '#dc3545'; });
    });
}
if (memberID) { loadTrainingLog(); loadGoal(); loadMilestones(); loadSelfEstimates(); }
loadTrainingVolume();
</script>
{{ end }}
