{{ define "content" }}
<div class="card">
    <h1>My Training Log</h1>

    <div id="beltSection" style="display:none;margin:1rem 0;">
        <div style="display:flex;align-items:center;gap:0.5rem;">
            <span id="beltIcon" style="display:inline-block;width:22px;height:12px;border-radius:2px;border:1px solid #ccc;"></span>
            <span id="beltName" style="font-weight:600;text-transform:capitalize;"></span>
            <span id="beltStripes"></span>
        </div>
    </div>

    <div id="stats" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin:1.5rem 0;">
        <div style="background:#e8f5e9;padding:1.25rem;border-radius:2px;text-align:center;">
            <div id="totalClasses" style="font-size:1.75rem;font-weight:bold;color:#2e7d32;">0</div>
            <div style="color:#666;margin-top:0.25rem;">Classes</div>
        </div>
        <div style="background:#e3f2fd;padding:1.25rem;border-radius:2px;text-align:center;">
            <div id="matHours" style="font-size:1.75rem;font-weight:bold;color:#1565c0;">0h</div>
            <div id="hoursSplit" style="color:#999;font-size:0.75rem;margin-top:0.15rem;"></div>
            <div style="color:#666;margin-top:0.25rem;">Flight Time</div>
        </div>
        <div style="background:#fff3e0;padding:1.25rem;border-radius:2px;text-align:center;">
            <div id="streak" style="font-size:1.75rem;font-weight:bold;color:#e65100;">0w</div>
            <div style="color:#666;margin-top:0.25rem;">Week Streak</div>
        </div>
    </div>

    <div id="progressSection" style="display:none;margin:0 0 1.5rem;">
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:0.35rem;">
            <span style="font-weight:600;font-size:0.9rem;">Progress toward <span id="nextBeltName" style="text-transform:capitalize;"></span></span>
            <span id="progressLabel" style="font-size:0.85rem;color:#666;"></span>
        </div>
        <div style="background:#e0e0e0;border-radius:4px;height:12px;overflow:hidden;">
            <div id="progressBar" style="height:100%;border-radius:4px;background:linear-gradient(90deg,#F9B232,#e65100);transition:width 0.5s;width:0%;"></div>
        </div>
    </div>

    <div id="badgesSection" style="display:none;margin-bottom:1.5rem;">
        <h2 style="margin-top:0;">Earned Badges</h2>
        <div id="badgesList" style="display:flex;flex-wrap:wrap;gap:0.75rem;"></div>
    </div>

    <div id="milestoneToast" style="display:none;position:fixed;top:1.5rem;right:1.5rem;background:#2e7d32;color:#fff;padding:1rem 1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:1000;font-weight:600;max-width:350px;"></div>

    <h2>Training Goal</h2>
    <div id="goalSection">
        <div id="currentGoal" style="display:none;background:#f3e5f5;padding:1rem;border-radius:2px;margin-bottom:1rem;">
            <strong>Current Goal:</strong> <span id="goalText"></span>
        </div>
        <div style="display:flex;align-items:center;gap:1rem;">
            <label style="margin:0;">Sessions per week:</label>
            <input type="number" id="goalTarget" value="3" style="width:80px;">
            <button onclick="setGoal()">Set Goal</button>
            <span id="goalMsg" style="color:#F9B232;"></span>
        </div>
    </div>

    <h2 style="margin-top:2rem;">Recent Attendance</h2>
    <div id="attendanceList" style="color:#6c757d;"><p style="font-style:italic;">No recent sessions. Check in at the kiosk to start tracking your training!</p></div>

    <p style="margin-top:2rem;"><a href="/dashboard" style="color:#F9B232;text-decoration:none;font-weight:600;">‚Üê Back to Dashboard</a></p>
</div>

<script>
var memberID = '{{ .MemberID }}';
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
var beltColors = {white:'#fff',blue:'#1565c0',purple:'#7b1fa2',brown:'#5d4037',black:'#212121',yellow:'#f9a825',orange:'#e65100',green:'#2e7d32',grey:'#9e9e9e'};
function loadTrainingLog() {
    if (!memberID) return;
    fetch('/api/training-log?member_id='+memberID).then(r=>r.json()).then(data => {
        document.getElementById('totalClasses').textContent = data.TotalClasses || 0;
        document.getElementById('matHours').textContent = Math.round(data.TotalMatHours || 0) + 'h';
        document.getElementById('streak').textContent = (data.CurrentStreak || 0) + 'w';

        // Recorded vs estimated hours split
        var rec = Math.round(data.RecordedHours || 0);
        var est = Math.round(data.EstimatedHours || 0);
        var bulk = Math.round(data.BulkEstimatedHours || 0);
        var parts = [];
        if (rec > 0) parts.push(rec + 'h recorded');
        if (est > 0) parts.push(est + 'h session est.');
        if (bulk > 0) parts.push(bulk + 'h bulk est.');
        if (parts.length > 0) {
            document.getElementById('hoursSplit').textContent = parts.join(' + ');
        }

        // Belt display
        if (data.Belt) {
            document.getElementById('beltSection').style.display = 'block';
            document.getElementById('beltIcon').style.background = beltColors[data.Belt] || '#ccc';
            document.getElementById('beltName').textContent = data.Belt;
            var stripeHtml = '';
            for (var i = 0; i < (data.Stripe || 0); i++) {
                stripeHtml += '<span style="display:inline-block;width:6px;height:6px;background:#fff;border:1px solid #999;border-radius:50%;margin-left:2px;vertical-align:middle;"></span>';
            }
            document.getElementById('beltStripes').innerHTML = stripeHtml;
        }

        // Progress bar toward next belt
        if (data.GradingMetric === 'sessions' && data.TermTotal > 0) {
            // Kids sessions mode: show term attendance progress
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('nextBeltName').textContent = data.NextBelt || 'next belt';
            var pct = Math.min(data.TermAttendancePct || 0, 100);
            document.getElementById('progressBar').style.width = pct.toFixed(0) + '%';
            document.getElementById('progressBar').style.background = data.TermEligible
                ? 'linear-gradient(90deg,#2e7d32,#43a047)'
                : 'linear-gradient(90deg,#F9B232,#e65100)';
            var label = (data.TermAttended||0) + ' / ' + data.TermTotal + ' sessions';
            if (data.TermName) label += ' (' + data.TermName + ')';
            label += ' ‚Äî ' + Math.round(pct) + '%';
            if (data.TermEligible) label += ' ‚úì eligible';
            document.getElementById('progressLabel').textContent = label;
        } else if (data.NextBelt && data.RequiredHours > 0) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('nextBeltName').textContent = data.NextBelt;
            document.getElementById('progressBar').style.width = Math.min(data.ProgressPct || 0, 100).toFixed(0) + '%';
            document.getElementById('progressLabel').textContent = Math.round(data.TotalMatHours || 0) + ' / ' + Math.round(data.RequiredHours) + 'h (' + Math.round(data.ProgressPct || 0) + '%)';
        }

        var el = document.getElementById('attendanceList');
        if (!data.Entries || data.Entries.length === 0) {
            el.innerHTML = '<p style="color:#6c757d;font-style:italic;">No recent sessions.</p>';
            return;
        }
        var recent = data.Entries.slice(0, 20);
        var html = '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#f8f9fa;border-bottom:2px solid #dee2e6;"><th style="padding:0.5rem;text-align:left;">Date</th><th style="padding:0.5rem;text-align:left;">Time</th><th style="padding:0.5rem;text-align:left;">Hours</th></tr></thead><tbody>';
        recent.forEach(s => {
            html += '<tr style="border-bottom:1px solid #dee2e6;"><td style="padding:0.5rem;">'+esc(s.Date)+'</td><td style="padding:0.5rem;">'+esc(s.CheckIn)+(s.CheckOut?' ‚Äì '+esc(s.CheckOut):'')+'</td><td style="padding:0.5rem;">'+s.DurationH.toFixed(1)+'h</td></tr>';
        });
        html += '</tbody></table>';
        el.innerHTML = html;
    }).catch(() => {
        document.getElementById('attendanceList').innerHTML = '<p style="color:#6c757d;font-style:italic;">Could not load training log.</p>';
    });
}
function loadGoal() {
    if (!memberID) return;
    fetch('/api/training-goals?member_id='+memberID).then(r=>r.json()).then(data => {
        if (data && data.ID) {
            document.getElementById('currentGoal').style.display = 'block';
            document.getElementById('goalText').textContent = data.Target + 'x ' + data.Period;
            document.getElementById('goalTarget').value = data.Target;
        }
    }).catch(() => {});
}
function setGoal() {
    if (!memberID) return;
    fetch('/api/training-goals',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        MemberID: memberID,
        Target: parseInt(document.getElementById('goalTarget').value) || 3,
        Period: 'weekly'
    })}).then(r=>{if(!r.ok)throw r;return r.json();})
    .then(() => {
        document.getElementById('goalMsg').textContent = 'Goal set!';
        loadGoal();
        setTimeout(() => document.getElementById('goalMsg').textContent = '', 2000);
    }).catch(() => document.getElementById('goalMsg').textContent = 'Error');
}
function loadMilestones() {
    if (!memberID) return;
    fetch('/api/member-milestones?member_id='+memberID).then(r=>r.json()).then(data => {
        if (!data || data.length === 0) return;
        document.getElementById('badgesSection').style.display = 'block';
        var html = '';
        data.forEach(function(item) {
            var icon = item.Milestone.BadgeIcon || 'üèÖ';
            html += '<div style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:0.75rem 1rem;text-align:center;min-width:100px;">';
            html += '<div style="font-size:2rem;">'+icon+'</div>';
            html += '<div style="font-weight:600;font-size:0.85rem;">'+esc(item.Milestone.Name)+'</div>';
            html += '</div>';
            // Show toast for unnotified milestones
            if (!item.Notified) {
                var toast = document.getElementById('milestoneToast');
                toast.textContent = icon + ' Congratulations! You earned: ' + item.Milestone.Name;
                toast.style.display = 'block';
                setTimeout(function(){ toast.style.display = 'none'; }, 5000);
            }
        });
        document.getElementById('badgesList').innerHTML = html;
    }).catch(function(){});
}
if (memberID) { loadTrainingLog(); loadGoal(); loadMilestones(); }
</script>
{{ end }}
