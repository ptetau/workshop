{{ define "content" }}
<div class="card" style="max-width:600px;margin:3rem auto;">
    <div style="text-align:center;margin-bottom:2rem;">
        <div style="font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;color:#6c757d;margin-bottom:0.5rem;">Workshop Jiu Jitsu</div>
        <h1 style="margin:0;font-weight:300;font-size:1.75rem;">Request Data Deletion</h1>
        <p style="margin:0.75rem 0 0;color:var(--text-muted);font-size:0.85rem;">GDPR - Right to erasure</p>
    </div>

    {{ if .Error }}
    <div style="background:#fff3f3;color:#c00;padding:0.75rem;border-left:3px solid #c00;margin-bottom:1.5rem;font-size:0.85rem;">
        {{ .Error }}
    </div>
    {{ end }}

    {{ if .ExistingRequest }}
    <div style="background:#f0f9ff;border-left:3px solid #0066cc;padding:0.75rem;margin-bottom:1.5rem;font-size:0.85rem;">
        <strong>Deletion Request Status:</strong> {{ .ExistingRequest.Status }}<br>
        <strong>Requested:</strong> {{ .ExistingRequest.RequestedAt | date "Jan 2, 2006 15:04" }}<br>
        <strong>Grace Period Ends:</strong> {{ .ExistingRequest.GracePeriodEnd | date "Jan 2, 2006 15:04" }}<br>
        {{ if .ExistingRequest.CanCancel }}
        <p style="margin-top:0.5rem;margin-bottom:0;">
            You can still <a href="/privacy/delete/cancel?id={{ .ExistingRequest.ID }}" style="color:#c00;">cancel this request</a> before the grace period ends.
        </p>
        {{ end }}
    </div>
    {{ end }}

    <div style="background:#fff8e1;border-left:3px solid #ff8f00;padding:0.75rem;margin-bottom:1.5rem;font-size:0.85rem;">
        <strong>Important:</strong> This will permanently delete your account and all associated data including:
        <ul style="margin:0.5rem 0;padding-left:1.5rem;">
            <li>Profile information and contact details</li>
            <li>Attendance history and training logs</li>
            <li>Messages and communications</li>
            <li>Grading history and belt progress</li>
        </ul>
        You have <strong>7 days</strong> to cancel this request before processing begins.
    </div>

    <form id="deletionForm" style="margin-top:1.5rem;">
        <input type="hidden" name="gorilla.csrf.Token" value="{{ .CSRFToken }}">

        <div style="background:#f8f9fa;padding:1rem;margin-bottom:1rem;border-radius:4px;">
            <div style="font-weight:500;margin-bottom:0.5rem;">Account to be deleted:</div>
            <div><strong>{{ .Member.FullName }}</strong></div>
            <div style="color:#6c757d;font-size:0.85rem;">{{ .Member.Email }}</div>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="confirmDelete" required>
                I understand that this action is irreversible and all my data will be permanently deleted.
            </label>
        </div>

        <button type="submit" style="width:100%;padding:0.85rem;background:#c00;" id="submitBtn" disabled>
            Request Data Deletion
        </button>
    </form>
</div>

<script>
document.getElementById('confirmDelete').addEventListener('change', function() {
    document.getElementById('submitBtn').disabled = !this.checked;
});

document.getElementById('deletionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!document.getElementById('confirmDelete').checked) return;

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Processing...';

    fetch('/api/privacy/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('input[name="gorilla.csrf.Token"]').value
        }
    })
    .then(function(r) {
        if (!r.ok) throw new Error('Request failed: ' + r.status);
        return r.json();
    })
    .then(function(data) {
        window.location.href = '/privacy/delete?success=1';
    })
    .catch(function(err) {
        alert('Error: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Request Data Deletion';
    });
});
</script>
{{ end }}
