{{ define "content" }}
<div class="card">
    <h1>Theme Carousel</h1>
    <p style="color:var(--text-muted);margin-bottom:1.5rem;">This week's curriculum across all classes, driven by the rotor system.</p>

    {{ if eq .Role "admin" "coach" }}
    <div style="margin-bottom:1.5rem;">
        <a href="/curriculum" style="display:inline-block;background:#1A1B1F;color:#fff;padding:0.4rem 1rem;text-decoration:none;font-size:0.85rem;font-weight:600;border-radius:2px;">Manage Curriculum →</a>
    </div>
    {{ end }}

    <div id="curriculumOverview"></div>

    <p style="margin-top:2rem;">
        <a href="/library" style="font-weight:600;">View Technical Library →</a>
    </p>
    <p><a href="/dashboard">← Back to Dashboard</a></p>
</div>

<script>
var userRole = '{{ .Role }}';
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}

function renderActiveTopic(topic) {
    var html = '<div style="display:flex;align-items:center;gap:0.5rem;">';
    html += '<span style="background:#F9B232;width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0;"></span>';
    html += '<strong>'+esc(topic.topic_name)+'</strong>';
    if (topic.votes > 0) {
        html += ' <span style="color:#6c757d;font-size:0.8rem;">('+topic.votes+' vote'+(topic.votes!==1?'s':'')+')</span>';
    }
    html += '</div>';
    if (topic.description) {
        html += '<p style="margin:0.25rem 0 0 1.1rem;color:#6c757d;font-size:0.85rem;">'+esc(topic.description)+'</p>';
    }
    return html;
}

function renderThemeRow(theme) {
    var html = '<div style="padding:0.75rem 0;border-bottom:1px solid #f0f0f0;">';
    html += '<div style="font-weight:600;color:#1A1B1F;font-size:0.9rem;margin-bottom:0.4rem;">'+esc(theme.theme_name)+'</div>';
    if (theme.active_topic) {
        html += renderActiveTopic(theme.active_topic);
    } else {
        html += '<span style="color:#6c757d;font-style:italic;font-size:0.85rem;">No active topic scheduled</span>';
    }
    if (theme.upcoming && theme.upcoming.length > 0) {
        html += '<div style="margin-top:0.5rem;margin-left:1.1rem;">';
        html += '<span style="font-size:0.75rem;color:#999;text-transform:uppercase;letter-spacing:0.5px;">Coming up:</span>';
        html += '<div style="color:#6c757d;font-size:0.85rem;margin-top:0.2rem;">';
        var names = [];
        for (var i = 0; i < Math.min(theme.upcoming.length, 5); i++) {
            names.push(esc(theme.upcoming[i].topic_name));
        }
        html += names.join(' → ');
        if (theme.upcoming.length > 5) html += ' → …';
        html += '</div></div>';
    }
    html += '</div>';
    return html;
}

function renderClassCurriculum(cc) {
    var html = '<div style="background:#fff;border:1px solid #e0e0e0;border-left:3px solid #F9B232;padding:1.25rem;margin-bottom:1.5rem;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">';
    html += '<strong style="font-size:1.1rem;">'+esc(cc.class_type_name)+'</strong>';
    html += '<span style="background:#f8f9fa;color:#666;padding:0.15rem 0.5rem;font-size:0.75rem;border-radius:2px;">'+esc(cc.rotor_name)+'</span>';
    html += '</div>';
    if (cc.themes.length === 0) {
        html += '<p style="color:#6c757d;font-style:italic;">No themes configured yet.</p>';
    } else {
        for (var i = 0; i < cc.themes.length; i++) {
            html += renderThemeRow(cc.themes[i]);
        }
    }
    html += '</div>';
    return html;
}

function loadCurriculum() {
    fetch('/api/curriculum/overview').then(function(r) {
        if (!r.ok) throw new Error('Failed to load curriculum');
        return r.json();
    }).then(function(data) {
        var container = document.getElementById('curriculumOverview');
        if (!data.class_curriculums || data.class_curriculums.length === 0) {
            container.innerHTML = '<p style="color:#6c757d;font-style:italic;">No active curriculum configured yet.</p>';
            if (userRole === 'admin' || userRole === 'coach') {
                container.innerHTML += '<p style="margin-top:0.5rem;"><a href="/curriculum">Set up a rotor to get started →</a></p>';
            }
            return;
        }
        var html = '';
        for (var i = 0; i < data.class_curriculums.length; i++) {
            html += renderClassCurriculum(data.class_curriculums[i]);
        }
        container.innerHTML = html;
    }).catch(function(err) {
        document.getElementById('curriculumOverview').innerHTML = '<p style="color:#c62828;">Error loading curriculum: '+esc(err.message)+'</p>';
    });
}

document.addEventListener('DOMContentLoaded', loadCurriculum);
</script>
{{ end }}
