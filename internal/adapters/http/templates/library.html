{{ define "content" }}
<div class="card">
    <h1>Technical Library</h1>
    <p style="color:#666;margin-bottom:1.5rem;">Curated clips promoted by coaches. Isolate sequences and study on repeat.</p>

    <div style="display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;align-items:center;">
        <select id="filterTheme" style="width:auto;min-width:200px;">
            <option value="">All Themes</option>
        </select>
        <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;cursor:pointer;">
            <input type="checkbox" id="filterPromoted" checked> Promoted only
        </label>
    </div>

    <div id="clipGrid"></div>

    <div id="clipPlayer" style="display:none;margin-top:2rem;background:#000;border-radius:8px;overflow:hidden;">
        <div id="playerContainer" style="position:relative;padding-bottom:56.25%;height:0;">
            <iframe id="ytPlayer" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allow="autoplay;encrypted-media" allowfullscreen></iframe>
        </div>
        <div id="playerInfo" style="background:#1a1a1a;padding:1rem;color:#fff;">
            <strong id="playerTitle"></strong>
            <span id="playerTime" style="color:#aaa;margin-left:1rem;"></span>
            <button onclick="closePlayer()" style="float:right;background:#dc3545;padding:0.4rem 0.8rem;font-size:0.85rem;">Close</button>
        </div>
    </div>

    {{ if eq .Role "admin" "coach" "member" }}
    <details id="addClipSection" style="margin-top:2rem;background:#f8f9fa;padding:1rem;border-radius:8px;">
        <summary style="cursor:pointer;font-weight:bold;">Add a Clip</summary>
        <form id="createClipForm" style="margin-top:1rem;">
            <div class="form-group">
                <label for="clipTheme">Theme</label>
                <select id="clipTheme" required></select>
            </div>
            <div class="form-group">
                <label for="clipTitle">Title</label>
                <input type="text" id="clipTitle" placeholder="e.g. Leg Lasso Entry from DLR" required>
            </div>
            <div class="form-group">
                <label for="clipURL">YouTube URL</label>
                <input type="text" id="clipURL" placeholder="https://www.youtube.com/watch?v=..." required>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group">
                    <label for="clipStart">Start (seconds)</label>
                    <input type="number" id="clipStart" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label for="clipEnd">End (seconds)</label>
                    <input type="number" id="clipEnd" min="1" required>
                </div>
            </div>
            <div class="form-group">
                <label for="clipNotes">Notes (optional)</label>
                <input type="text" id="clipNotes" placeholder="Technique notes...">
            </div>
            <button type="submit">Save Clip</button>
        </form>
    </details>
    {{ end }}

    <p style="margin-top:2rem;">
        <a href="/themes" style="color:#007bff;font-weight:600;">← View Themes</a>
        &nbsp;·&nbsp;
        <a href="/dashboard">← Back to Dashboard</a>
    </p>
</div>

<script>
var userRole = '{{ .Role }}';
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}

var allThemes = [];

function loadThemeOptions() {
    return fetch('/api/themes').then(r=>r.json()).then(themes => {
        allThemes = themes;
        var sel = document.getElementById('filterTheme');
        var clipSel = document.getElementById('clipTheme');
        themes.forEach(t => {
            var opt = document.createElement('option');
            opt.value = t.ID;
            opt.textContent = t.Name + ' (' + t.Program + ')';
            sel.appendChild(opt);
            if (clipSel) {
                clipSel.appendChild(opt.cloneNode(true));
            }
        });
        // If URL has theme_id, pre-select it
        var params = new URLSearchParams(window.location.search);
        var tid = params.get('theme_id');
        if (tid) {
            sel.value = tid;
            document.getElementById('filterPromoted').checked = false;
        }
    });
}

function getThemeName(id) {
    var t = allThemes.find(x => x.ID === id);
    return t ? t.Name : 'Unknown';
}

function loadClips() {
    var themeID = document.getElementById('filterTheme').value;
    var promoted = document.getElementById('filterPromoted').checked;
    var url = '/api/clips?';
    if (promoted && !themeID) {
        url += 'promoted=true';
    } else if (themeID) {
        url += 'theme_id=' + themeID;
    } else {
        url += 'promoted=true';
    }
    fetch(url).then(r=>r.json()).then(clips => {
        var grid = document.getElementById('clipGrid');
        if (!clips || clips.length === 0) {
            grid.innerHTML = '<p style="color:#6c757d;font-style:italic;">No clips found.</p>';
            return;
        }
        var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;">';
        clips.forEach(c => {
            var thumb = c.YouTubeID ? 'https://img.youtube.com/vi/'+esc(c.YouTubeID)+'/mqdefault.jpg' : '';
            var dur = c.EndSeconds - c.StartSeconds;
            var promoteBadge = c.Promoted ? '<span style="background:#28a745;color:#fff;padding:0.15rem 0.5rem;border-radius:10px;font-size:0.75rem;">Promoted</span>' : '';
            var promoteBtn = '';
            if (!c.Promoted && (userRole === 'admin' || userRole === 'coach')) {
                promoteBtn = '<button onclick="promoteClip(\''+esc(c.ID)+'\')" style="background:#6f42c1;padding:0.3rem 0.6rem;font-size:0.8rem;margin-top:0.5rem;">Promote</button>';
            }
            html += '<div style="background:#fff;border:1px solid #dee2e6;border-radius:8px;overflow:hidden;cursor:pointer;" onclick="playClip(\''+esc(c.YouTubeID)+'\','+c.StartSeconds+','+c.EndSeconds+',\''+esc(c.Title)+'\')">'
                + (thumb ? '<img src="'+thumb+'" style="width:100%;height:160px;object-fit:cover;" alt="">' : '<div style="height:160px;background:#333;"></div>')
                + '<div style="padding:0.75rem;">'
                + '<div style="display:flex;justify-content:space-between;align-items:start;">'
                + '<strong style="font-size:0.95rem;">'+esc(c.Title)+'</strong>'
                + promoteBadge
                + '</div>'
                + '<div style="color:#666;font-size:0.85rem;margin-top:0.25rem;">'+esc(getThemeName(c.ThemeID))+' · '+dur+'s loop</div>'
                + (c.Notes ? '<div style="color:#888;font-size:0.8rem;margin-top:0.25rem;">'+esc(c.Notes)+'</div>' : '')
                + promoteBtn
                + '</div></div>';
        });
        html += '</div>';
        grid.innerHTML = html;
    });
}

function playClip(ytID, start, end, title) {
    var player = document.getElementById('clipPlayer');
    var iframe = document.getElementById('ytPlayer');
    iframe.src = 'https://www.youtube.com/embed/'+ytID+'?autoplay=1&mute=1&start='+start+'&end='+end+'&loop=1&playlist='+ytID;
    document.getElementById('playerTitle').textContent = title;
    document.getElementById('playerTime').textContent = start+'s – '+end+'s ('+( end-start)+'s loop)';
    player.style.display = 'block';
    player.scrollIntoView({behavior:'smooth'});
}

function closePlayer() {
    document.getElementById('clipPlayer').style.display = 'none';
    document.getElementById('ytPlayer').src = '';
}

function promoteClip(clipID) {
    event.stopPropagation();
    fetch('/api/clips/promote', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ClipID: clipID})
    }).then(r => {
        if (!r.ok) return r.text().then(t => { throw new Error(t); });
        return r.json();
    }).then(() => loadClips()).catch(err => alert('Error: ' + err.message));
}

document.addEventListener('DOMContentLoaded', function() {
    loadThemeOptions().then(() => loadClips());
});

document.getElementById('filterTheme').addEventListener('change', loadClips);
document.getElementById('filterPromoted').addEventListener('change', loadClips);

var clipForm = document.getElementById('createClipForm');
if (clipForm) {
    clipForm.addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('/api/clips', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                ThemeID: document.getElementById('clipTheme').value,
                Title: document.getElementById('clipTitle').value,
                YouTubeURL: document.getElementById('clipURL').value,
                StartSeconds: parseInt(document.getElementById('clipStart').value),
                EndSeconds: parseInt(document.getElementById('clipEnd').value),
                Notes: document.getElementById('clipNotes').value
            })
        }).then(r => {
            if (!r.ok) return r.text().then(t => { throw new Error(t); });
            return r.json();
        }).then(() => {
            clipForm.reset();
            loadClips();
        }).catch(err => alert('Error: ' + err.message));
    });
}
</script>
{{ end }}
