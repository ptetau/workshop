{{ define "content" }}
<div class="card">
    <h1>Technical Library</h1>
    <p style="color:var(--text-muted);margin-bottom:1.5rem;">Curated clips promoted by coaches. Isolate sequences and study on repeat.</p>

    <div style="display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;align-items:center;">
        <select id="filterTheme" style="width:auto;min-width:200px;">
            <option value="">All Themes</option>
        </select>
        <input type="text" id="searchQuery" placeholder="Search clips..." style="width:auto;min-width:200px;">
        <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;cursor:pointer;">
            <input type="checkbox" id="filterPromoted" checked> Promoted only
        </label>
    </div>

    <div id="clipGrid"></div>

    <div id="clipPlayer" style="display:none;margin-top:2rem;background:#000;border-radius:2px;overflow:hidden;">
        <div id="playerContainer" style="position:relative;padding-bottom:56.25%;height:0;">
            <iframe id="ytPlayer" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allow="autoplay;encrypted-media" allowfullscreen></iframe>
        </div>
        <div id="playerInfo" style="background:#1a1a1a;padding:1rem;color:#fff;">
            <strong id="playerTitle"></strong>
            <span id="playerTime" style="color:#aaa;margin-left:1rem;"></span>
            <button id="muteToggle" onclick="toggleMute()" style="float:right;background:#1A1B1F;border:1px solid rgba(255,255,255,0.15);padding:0.4rem 0.8rem;font-size:0.8rem;margin-left:0.5rem;">Unmute</button>
            <button onclick="closePlayer()" style="float:right;background:#F9B232;padding:0.4rem 0.8rem;font-size:0.8rem;">Close</button>
        </div>
    </div>

    {{ if eq .Role "admin" "coach" "member" }}
    <details id="addClipSection" style="margin-top:2rem;background:var(--bg);padding:1rem;">
        <summary style="cursor:pointer;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.5px;">Add a Clip</summary>
        <form id="createClipForm" style="margin-top:1rem;">
            <div class="form-group">
                <label for="clipTheme">Theme</label>
                <select id="clipTheme" required></select>
            </div>
            <div class="form-group">
                <label for="clipTitle">Title</label>
                <input type="text" id="clipTitle" placeholder="e.g. Leg Lasso Entry from DLR" maxlength="200" required>
            </div>
            <div class="form-group">
                <label for="clipURL">YouTube URL</label>
                <input type="text" id="clipURL" placeholder="https://www.youtube.com/watch?v=..." maxlength="2048" required>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group">
                    <label for="clipStart">Start (mm:ss)</label>
                    <input type="text" id="clipStart" placeholder="12:34" inputmode="numeric" required>
                </div>
                <div class="form-group">
                    <label for="clipEnd">End (mm:ss)</label>
                    <input type="text" id="clipEnd" placeholder="12:44" inputmode="numeric" required>
                </div>
            </div>
            <div class="form-group">
                <label for="clipNotes">Notes (optional)</label>
                <input type="text" id="clipNotes" placeholder="Technique notes..." maxlength="1000">
            </div>
            <button type="submit">Save Clip</button>
        </form>
    </details>
    {{ end }}

    <p style="margin-top:2rem;">
        <a href="/themes" style="font-weight:600;">&larr; View Themes</a>
        &nbsp;·&nbsp;
        <a href="/dashboard">&larr; Back to Dashboard</a>
    </p>
</div>

<script>
var userRole = '{{ .Role }}';
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}

var allThemes = [];

function loadThemeOptions() {
    return fetch('/api/themes').then(r=>r.json()).then(themes => {
        allThemes = themes;
        var sel = document.getElementById('filterTheme');
        var clipSel = document.getElementById('clipTheme');
        themes.forEach(t => {
            var opt = document.createElement('option');
            opt.value = t.ID;
            opt.textContent = t.Name + ' (' + t.Program + ')';
            sel.appendChild(opt);
            if (clipSel) {
                clipSel.appendChild(opt.cloneNode(true));
            }
        });
        // If URL has theme_id, pre-select it
        var params = new URLSearchParams(window.location.search);
        var tid = params.get('theme_id');
        if (tid) {
            sel.value = tid;
            document.getElementById('filterPromoted').checked = false;
            if (clipSel) {
                clipSel.value = tid;
            }
        }
    });
}

function parseTimestampToSeconds(raw) {
    var s = (raw || '').trim();
    if (!s) throw new Error('timestamp is required');
    if (/^\d+$/.test(s)) {
        var sec = parseInt(s, 10);
        if (isNaN(sec) || sec < 0) throw new Error('timestamp must be >= 0');
        return sec;
    }
    var parts = s.split(':');
    if (parts.length !== 2 && parts.length !== 3) throw new Error('timestamp must be seconds (e.g. 754) or mm:ss (e.g. 12:34)');
    for (var i = 0; i < parts.length; i++) {
        if (!/^\d+$/.test(parts[i])) throw new Error('timestamp must contain only numbers and :');
    }
    var nums = parts.map(p => parseInt(p, 10));
    var hh = 0, mm = 0, ss = 0;
    if (nums.length === 2) {
        mm = nums[0];
        ss = nums[1];
    } else {
        hh = nums[0];
        mm = nums[1];
        ss = nums[2];
    }
    if (ss < 0 || ss > 59) throw new Error('seconds must be 0-59');
    if (mm < 0 || mm > 59 && nums.length === 3) throw new Error('minutes must be 0-59 for hh:mm:ss');
    if (hh < 0) throw new Error('hours must be >= 0');
    return (hh * 3600) + (mm * 60) + ss;
}

function getThemeName(id) {
    var t = allThemes.find(x => x.ID === id);
    return t ? t.Name : 'Unknown';
}

function loadClips() {
    var themeID = document.getElementById('filterTheme').value;
    var promoted = document.getElementById('filterPromoted').checked;
    var query = document.getElementById('searchQuery').value.trim();
    var url = '/api/clips?';
    if (query) {
        url += 'q=' + encodeURIComponent(query);
        if (themeID) url += '&theme_id=' + themeID;
        if (promoted) url += '&promoted=true';
    } else if (promoted && !themeID) {
        url += 'promoted=true';
    } else if (themeID) {
        url += 'theme_id=' + themeID;
    } else {
        url += 'promoted=true';
    }
    fetch(url).then(r=>r.json()).then(clips => {
        var grid = document.getElementById('clipGrid');
        if (!clips || clips.length === 0) {
            grid.innerHTML = '<p style="color:#6c757d;font-style:italic;">No clips found.</p>';
            return;
        }
        var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;">';
        clips.forEach(c => {
            var thumb = c.YouTubeID ? 'https://img.youtube.com/vi/'+esc(c.YouTubeID)+'/mqdefault.jpg' : '';
            var dur = c.EndSeconds - c.StartSeconds;
            var promoteBadge = c.Promoted ? '<span style="background:#F9B232;color:#fff;padding:0.15rem 0.5rem;font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Promoted</span>' : '';
            var promoteBtn = '';
            if (!c.Promoted && (userRole === 'admin' || userRole === 'coach')) {
                promoteBtn = '<button onclick="promoteClip(event,\''+esc(c.ID)+'\')" style="background:#1A1B1F;padding:0.3rem 0.6rem;font-size:0.75rem;margin-top:0.5rem;letter-spacing:0.5px;">Promote</button>';
            }
            html += '<div style="background:#fff;border:1px solid #e0e0e0;overflow:hidden;cursor:pointer;" onclick="playClip(\''+esc(c.YouTubeID)+'\','+c.StartSeconds+','+c.EndSeconds+',\''+esc(c.Title)+'\')">'
                + (thumb ? '<img src="'+thumb+'" style="width:100%;height:160px;object-fit:cover;" alt="">' : '<div style="height:160px;background:#333;"></div>')
                + '<div style="padding:0.75rem;">'
                + '<div style="display:flex;justify-content:space-between;align-items:start;">'
                + '<strong style="font-size:0.95rem;">'+esc(c.Title)+'</strong>'
                + promoteBadge
                + '</div>'
                + '<div style="color:#666;font-size:0.85rem;margin-top:0.25rem;">'+esc(getThemeName(c.ThemeID))+' · '+dur+'s loop</div>'
                + (c.Notes ? '<div style="color:#888;font-size:0.8rem;margin-top:0.25rem;">'+esc(c.Notes)+'</div>' : '')
                + promoteBtn
                + '</div></div>';
        });
        html += '</div>';
        grid.innerHTML = html;
    });
}

function playClip(ytID, start, end, title) {
    var player = document.getElementById('clipPlayer');
    var iframe = document.getElementById('ytPlayer');

    // NOTE: enablejsapi=1 allows toggling mute/unmute via postMessage commands.
    // Keep clips muted by default for gym-friendly playback.
    // loop=1 with playlist=ytID enables seamless looping within the start/end bounds.
    iframe.src = 'https://www.youtube.com/embed/'+ytID
        + '?autoplay=1&mute=1'
        + '&start='+start+'&end='+end
        + '&loop=1&playlist='+ytID
        + '&enablejsapi=1&origin=' + encodeURIComponent(window.location.origin);
    document.getElementById('playerTitle').textContent = title;
    document.getElementById('playerTime').textContent = start+'s – '+end+'s ('+( end-start)+'s loop)';
    player.style.display = 'block';
    player.scrollIntoView({behavior:'smooth'});

    setMuteUI(true);
}

function setMuteUI(isMuted) {
    var btn = document.getElementById('muteToggle');
    if (!btn) return;
    btn.dataset.muted = isMuted ? 'true' : 'false';
    btn.textContent = isMuted ? 'Unmute' : 'Mute';
}

function sendYTCommand(func) {
    var iframe = document.getElementById('ytPlayer');
    if (!iframe || !iframe.contentWindow) return;
    // YouTube iframe API command format.
    iframe.contentWindow.postMessage(JSON.stringify({
        event: 'command',
        func: func,
        args: []
    }), 'https://www.youtube.com');
}

function toggleMute() {
    var btn = document.getElementById('muteToggle');
    if (!btn) return;
    var muted = btn.dataset.muted !== 'false';
    if (muted) {
        sendYTCommand('unMute');
        setMuteUI(false);
        return;
    }
    sendYTCommand('mute');
    setMuteUI(true);
}

function closePlayer() {
    document.getElementById('clipPlayer').style.display = 'none';
    document.getElementById('ytPlayer').src = '';
    setMuteUI(true);
}

function promoteClip(ev, clipID) {
    if (ev && ev.stopPropagation) ev.stopPropagation();
    fetch('/api/clips/promote', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ClipID: clipID})
    }).then(r => {
        if (!r.ok) return r.text().then(t => { throw new Error(t); });
        return r.json();
    }).then(() => loadClips()).catch(err => alert('Error: ' + err.message));
}

document.addEventListener('DOMContentLoaded', function() {
    loadThemeOptions().then(() => loadClips());
});

document.getElementById('filterTheme').addEventListener('change', loadClips);
document.getElementById('filterPromoted').addEventListener('change', loadClips);
document.getElementById('searchQuery').addEventListener('input', function() {
    // Debounce search input to avoid excessive API calls
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(loadClips, 300);
});

var clipForm = document.getElementById('createClipForm');
if (clipForm) {
    clipForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var themeID = document.getElementById('clipTheme').value;
        var startSeconds, endSeconds;
        try {
            startSeconds = parseTimestampToSeconds(document.getElementById('clipStart').value);
            endSeconds = parseTimestampToSeconds(document.getElementById('clipEnd').value);
        } catch (err) {
            alert('Error: ' + err.message);
            return;
        }
        fetch('/api/clips', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                ThemeID: themeID,
                Title: document.getElementById('clipTitle').value,
                YouTubeURL: document.getElementById('clipURL').value,
                StartSeconds: startSeconds,
                EndSeconds: endSeconds,
                Notes: document.getElementById('clipNotes').value
            })
        }).then(r => {
            if (!r.ok) return r.text().then(t => { throw new Error(t); });
            return r.json();
        }).then(() => {
            clipForm.reset();
            // Make the new member-created clip visible immediately.
            document.getElementById('filterTheme').value = themeID;
            document.getElementById('filterPromoted').checked = false;
            var clipTheme = document.getElementById('clipTheme');
            if (clipTheme) {
                clipTheme.value = themeID;
            }
            loadClips();
        }).catch(err => alert('Error: ' + err.message));
    });
}
</script>
{{ end }}
