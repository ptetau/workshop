{{ define "content" }}
<div class="card">
    <h1>Curriculum Management</h1>

    <div style="margin-bottom:1.5rem;">
        <label style="font-weight:600;">Select Class:</label>
        <select id="classSelect" style="padding:0.5rem;border:1px solid #ccc;border-radius:4px;min-width:200px;" onchange="onClassChange()">
            <option value="">Loading...</option>
        </select>
    </div>

    <div id="rotorSection" style="display:none;">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
            <h2 style="margin:0;" id="rotorTitle">Rotors</h2>
            <button onclick="showCreateRotor()" style="padding:0.25rem 0.75rem;font-size:0.85rem;">+ New Rotor</button>
        </div>

        <div id="createRotorForm" style="display:none;background:#f8f9fa;padding:1rem;border-radius:2px;margin-bottom:1rem;">
            <div class="form-group">
                <label>Rotor Name</label>
                <input type="text" id="rotorName" placeholder="e.g. Gi Express v2" maxlength="100" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
            </div>
            <button onclick="createRotor()">Create Draft</button>
            <button onclick="hideCreateRotor()" style="background:#6c757d;">Cancel</button>
            <span id="rotorMsg" style="margin-left:0.5rem;color:#F9B232;"></span>
        </div>

        <div id="rotorList"></div>
    </div>

    <div id="rotorDetail" style="display:none;margin-top:1.5rem;">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
            <h2 style="margin:0;" id="detailTitle"></h2>
            <button id="renameRotorBtn" onclick="showRenameRotor()" style="display:none;background:transparent;border:1px solid #ccc;padding:0.2rem 0.5rem;font-size:0.75rem;cursor:pointer;color:var(--text-muted);">Rename</button>
            <span id="detailStatus" style="padding:0.15rem 0.5rem;border-radius:4px;font-size:0.8rem;font-weight:600;"></span>
            <button id="activateBtn" onclick="activateRotor()" style="display:none;background:#28a745;padding:0.25rem 0.75rem;font-size:0.85rem;">Activate</button>
            <button id="deleteRotorBtn" onclick="deleteRotor()" style="display:none;background:#dc3545;padding:0.25rem 0.75rem;font-size:0.85rem;">Delete</button>
            <label id="previewLabel" style="display:none;margin-left:auto;cursor:pointer;">
                <input type="checkbox" id="previewToggle" onchange="togglePreview()"> Member Preview
            </label>
        </div>
        <div id="renameRotorForm" style="display:none;background:#f8f9fa;padding:0.75rem;border-radius:2px;margin-bottom:0.75rem;display:none;">
            <div style="display:flex;gap:0.5rem;align-items:center;">
                <input type="text" id="renameRotorInput" maxlength="100" style="flex:1;padding:0.4rem;border:1px solid #ccc;border-radius:4px;">
                <button onclick="renameRotor()" style="padding:0.3rem 0.6rem;font-size:0.85rem;">Save</button>
                <button onclick="hideRenameRotor()" style="background:#6c757d;padding:0.3rem 0.6rem;font-size:0.85rem;">Cancel</button>
            </div>
        </div>
        <a href="#" onclick="backToRotors();return false;" style="color:#F9B232;text-decoration:none;font-size:0.9rem;">← Back to rotors</a>

        <div style="margin-top:1rem;">
            <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem;">
                <h3 style="margin:0;">Themes</h3>
                <button id="addThemeBtn" onclick="showAddTheme()" style="padding:0.2rem 0.5rem;font-size:0.8rem;">+ Theme</button>
            </div>
            <div id="themesContainer"></div>
            <div id="addThemeRow" style="display:none;margin-top:0.5rem;">
                <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
                    <input type="text" id="newThemeName" placeholder="New theme name (e.g. Standing)" maxlength="100"
                        style="flex:1;min-width:140px;padding:0.4rem;border:1px solid #ccc;border-radius:4px;font-size:0.9rem;"
                        onkeydown="if(event.key==='Enter'){addTheme();} if(event.key==='Escape'){hideAddTheme();}">
                    <label style="display:flex;align-items:center;gap:0.25rem;font-size:0.85rem;cursor:pointer;"><input type="checkbox" id="themeHidden"> Surprise</label>
                    <button onclick="addTheme()" style="padding:0.3rem 0.6rem;font-size:0.85rem;">Add</button>
                    <button onclick="hideAddTheme()" style="background:#6c757d;padding:0.3rem 0.6rem;font-size:0.85rem;">Cancel</button>
                    <span id="themeErr" style="color:#dc3545;font-size:0.8rem;"></span>
                </div>
            </div>
        </div>
    </div>

    <p style="margin-top:2rem;"><a href="/dashboard" style="color:#F9B232;text-decoration:none;font-weight:600;">← Back to Dashboard</a></p>
</div>

<script>
var classTypes = [];
var currentClassID = '';
var currentRotorID = '';
var currentRotor = null;

function getHashParams() {
    var params = {};
    location.hash.replace('#','').split('&').forEach(function(p){
        var kv = p.split('='); if(kv[0]) params[kv[0]] = decodeURIComponent(kv[1]||'');
    });
    return params;
}
function updateHash() {
    var h = '';
    if (currentClassID) h += 'class='+encodeURIComponent(currentClassID);
    if (currentRotorID) h += '&rotor='+encodeURIComponent(currentRotorID);
    history.replaceState(null, '', '#'+h);
}

function loadClassTypes() {
    fetch('/api/class-types').then(r=>r.json()).then(data => {
        classTypes = data || [];
        var sel = document.getElementById('classSelect');
        sel.innerHTML = '<option value="">— Select a class —</option>';
        classTypes.forEach(ct => {
            sel.innerHTML += '<option value="'+ct.ID+'">'+ct.Name+'</option>';
        });
        var hp = getHashParams();
        if (hp.class) {
            sel.value = hp.class;
            currentClassID = hp.class;
            document.getElementById('rotorSection').style.display = 'block';
            loadRotors(function() {
                if (hp.rotor) openRotor(hp.rotor);
            });
        }
    });
}

function onClassChange() {
    currentClassID = document.getElementById('classSelect').value;
    currentRotorID = '';
    if (!currentClassID) {
        document.getElementById('rotorSection').style.display = 'none';
        document.getElementById('rotorDetail').style.display = 'none';
        updateHash();
        return;
    }
    document.getElementById('rotorSection').style.display = 'block';
    document.getElementById('rotorDetail').style.display = 'none';
    updateHash();
    loadRotors();
}

function loadRotors(callback) {
    fetch('/api/rotors?class_type_id='+currentClassID).then(r=>r.json()).then(data => {
        var list = document.getElementById('rotorList');
        if (!data || data.length === 0) {
            list.innerHTML = '<p style="color:#6c757d;">No rotors yet. Create one to get started.</p>';
            return;
        }
        var html = '<table style="width:100%;border-collapse:collapse;">';
        html += '<thead><tr style="background:#f8f9fa;border-bottom:2px solid #dee2e6;">';
        html += '<th style="padding:0.5rem;text-align:left;">Name</th>';
        html += '<th style="padding:0.5rem;text-align:left;">Version</th>';
        html += '<th style="padding:0.5rem;text-align:left;">Status</th>';
        html += '<th style="padding:0.5rem;text-align:right;">Actions</th>';
        html += '</tr></thead><tbody>';
        data.forEach(r => {
            var statusColor = r.Status === 'active' ? '#28a745' : r.Status === 'draft' ? '#F9B232' : '#6c757d';
            html += '<tr style="border-bottom:1px solid #dee2e6;">';
            html += '<td style="padding:0.5rem;font-weight:600;">'+r.Name+'</td>';
            html += '<td style="padding:0.5rem;">v'+r.Version+'</td>';
            html += '<td style="padding:0.5rem;"><span style="color:'+statusColor+';font-weight:600;text-transform:uppercase;font-size:0.85rem;">'+r.Status+'</span></td>';
            html += '<td style="padding:0.5rem;text-align:right;"><button onclick="openRotor(\''+r.ID+'\')" style="padding:0.25rem 0.75rem;font-size:0.85rem;">Manage</button></td>';
            html += '</tr>';
        });
        html += '</tbody></table>';
        list.innerHTML = html;
        if (callback) callback();
    });
}

function showCreateRotor() { document.getElementById('createRotorForm').style.display='block'; }
function hideCreateRotor() { document.getElementById('createRotorForm').style.display='none'; }

function createRotor() {
    var name = document.getElementById('rotorName').value.trim();
    if (!name) { document.getElementById('rotorMsg').textContent='Name required'; return; }
    fetch('/api/rotors', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({class_type_id:currentClassID,name:name})})
        .then(r=>{if(!r.ok) throw r; return r.json();})
        .then(()=>{hideCreateRotor();document.getElementById('rotorName').value='';loadRotors();})
        .catch(()=>document.getElementById('rotorMsg').textContent='Error creating rotor');
}

function openRotor(id) {
    currentRotorID = id;
    updateHash();
    fetch('/api/rotors/by-id?id='+id).then(r=>r.json()).then(r => {
        currentRotor = r;
        document.getElementById('rotorSection').style.display = 'none';
        document.getElementById('rotorDetail').style.display = 'block';
        document.getElementById('detailTitle').textContent = r.Name + ' (v' + r.Version + ')';
        var statusEl = document.getElementById('detailStatus');
        statusEl.textContent = r.Status.toUpperCase();
        statusEl.style.background = r.Status==='active'?'#28a745':r.Status==='draft'?'#F9B232':'#6c757d';
        statusEl.style.color = '#fff';
        document.getElementById('renameRotorBtn').style.display = r.Status==='draft'?'inline-block':'none';
        document.getElementById('activateBtn').style.display = r.Status==='draft'?'inline-block':'none';
        document.getElementById('deleteRotorBtn').style.display = r.Status!=='active'?'inline-block':'none';
        document.getElementById('addThemeBtn').style.display = r.Status==='draft'?'inline-block':'none';
        document.getElementById('addThemeRow').style.display = 'none';
        document.getElementById('previewLabel').style.display = r.Status==='active'?'inline-block':'none';
        document.getElementById('previewToggle').checked = r.PreviewOn;
        loadThemes();
    });
}

function backToRotors() {
    currentRotorID = '';
    updateHash();
    document.getElementById('rotorDetail').style.display = 'none';
    document.getElementById('rotorSection').style.display = 'block';
    loadRotors();
}

function showRenameRotor() {
    document.getElementById('renameRotorInput').value = currentRotor.Name;
    document.getElementById('renameRotorForm').style.display = 'block';
    document.getElementById('renameRotorInput').focus();
}
function hideRenameRotor() { document.getElementById('renameRotorForm').style.display = 'none'; }
function renameRotor() {
    var name = document.getElementById('renameRotorInput').value.trim();
    if (!name) return;
    fetch('/api/rotors/by-id?id='+currentRotorID,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name})})
        .then(r=>{if(!r.ok) throw r; return r.json();})
        .then(()=>{hideRenameRotor();openRotor(currentRotorID);});
}

function activateRotor() {
    if (!confirm('Activate this rotor? Any currently active rotor will be archived.')) return;
    fetch('/api/rotors/activate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:currentRotorID})})
        .then(r=>{if(!r.ok) throw r; return r.json();})
        .then(()=>openRotor(currentRotorID));
}

function deleteRotor() {
    if (!confirm('Delete this rotor?')) return;
    fetch('/api/rotors/by-id?id='+currentRotorID,{method:'DELETE',headers:{'Content-Type':'application/json'}})
        .then(r=>{if(!r.ok) throw r;})
        .then(()=>backToRotors());
}

function togglePreview() {
    var on = document.getElementById('previewToggle').checked;
    fetch('/api/rotors/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:currentRotorID,preview_on:on})});
}

var saveTimers = {};

function showAddTheme() {
    document.getElementById('addThemeRow').style.display='block';
    document.getElementById('newThemeName').value='';
    document.getElementById('themeHidden').checked=false;
    document.getElementById('themeErr').textContent='';
    document.getElementById('newThemeName').focus();
}
function hideAddTheme() { document.getElementById('addThemeRow').style.display='none'; }

function addTheme() {
    var name = document.getElementById('newThemeName').value.trim();
    if (!name) { document.getElementById('themeErr').textContent='Name required'; return; }
    var hidden = document.getElementById('themeHidden').checked;
    document.getElementById('themeErr').textContent='';
    fetch('/api/rotors/themes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({rotor_id:currentRotorID,name:name,position:0,hidden:hidden})})
        .then(r=>{if(!r.ok) return r.text().then(t=>{throw new Error(t);}); return r.json();})
        .then(()=>{hideAddTheme();loadThemes();})
        .catch(e=>{document.getElementById('themeErr').textContent=e.message;});
}

function loadThemes() {
    fetch('/api/rotors/themes?rotor_id='+currentRotorID).then(r=>r.json()).then(themes => {
        var container = document.getElementById('themesContainer');
        var isDraft = currentRotor && currentRotor.Status === 'draft';
        var isActive = currentRotor && currentRotor.Status === 'active';
        if (!themes || themes.length === 0) {
            container.innerHTML = isDraft ? '<p style="color:#6c757d;">No themes yet. Add one below.</p>' : '<p style="color:#6c757d;">No themes.</p>';
            document.getElementById('addThemeRow').style.display = isDraft ? 'block' : 'none';
            if (isDraft) document.getElementById('newThemeName').focus();
            return;
        }
        var html = '';
        themes.forEach(th => {
            html += '<div style="border:1px solid #dee2e6;border-radius:4px;margin-bottom:0.75rem;" id="theme-'+th.ID+'">';
            html += '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.6rem 0.75rem;background:#f8f9fa;border-bottom:1px solid #dee2e6;">';
            html += '<strong style="font-size:0.95rem;">'+th.Name+'</strong>';
            if (th.Hidden) html += '<span style="background:#6f42c1;color:#fff;font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:3px;">Surprise</span>';
            if (isDraft) {
                html += '<button onclick="deleteTheme(\''+th.ID+'\')" style="margin-left:auto;background:#dc3545;padding:0.1rem 0.4rem;font-size:0.7rem;line-height:1;">×</button>';
            }
            html += '</div>';
            html += '<div id="topicList-'+th.ID+'" style="padding:0.25rem 0;"><span style="color:#6c757d;font-size:0.85rem;padding:0.25rem 0.75rem;">Loading…</span></div>';
            html += '</div>';
        });
        container.innerHTML = html;
        themes.forEach(th => loadTopics(th.ID));
        if (isDraft) {
            document.getElementById('addThemeRow').style.display = 'block';
        }
    });
}

function deleteTheme(id) {
    if (!confirm('Delete this theme and all its topics?')) return;
    fetch('/api/rotors/themes?id='+id,{method:'DELETE',headers:{'Content-Type':'application/json'}}).then(()=>loadThemes());
}

function addTopic(themeID) {
    var input = document.getElementById('newTopic-'+themeID);
    var name = input.value.trim();
    if (!name) return;
    input.disabled = true;
    fetch('/api/rotors/topics',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({rotor_theme_id:themeID,name:name,duration_weeks:1})})
        .then(r=>{if(!r.ok) return r.text().then(t=>{throw new Error(t);}); return r.json();})
        .then(()=>{input.value='';input.disabled=false;loadTopics(themeID);setTimeout(()=>{var el=document.getElementById('newTopic-'+themeID);if(el)el.focus();},100);})
        .catch(e=>{input.disabled=false;showTopicErr(themeID,null,e.message);});
}

function autoSaveTopic(topicID, themeID, field, value) {
    var key = topicID+'-'+field;
    if (saveTimers[key]) clearTimeout(saveTimers[key]);
    saveTimers[key] = setTimeout(function(){
        var body = {};
        body[field] = field === 'duration_weeks' ? (parseInt(value)||1) : value;
        fetch('/api/rotors/topics?id='+topicID,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
            .then(r=>{
                if(!r.ok) return r.text().then(t=>{throw new Error(t);});
                showTopicSaved(topicID);
            })
            .catch(e=>{showTopicErr(themeID,topicID,e.message);});
    }, 400);
}

function showTopicSaved(topicID) {
    var el = document.getElementById('status-'+topicID);
    if(el){el.textContent='✓';el.style.color='#28a745';setTimeout(()=>{if(el)el.textContent='';},1500);}
}

function showTopicErr(themeID, topicID, msg) {
    var id = topicID ? 'status-'+topicID : 'themeTopicErr-'+themeID;
    var el = document.getElementById(id);
    if(el){el.textContent=msg;el.style.color='#dc3545';setTimeout(()=>{if(el)el.textContent='';},4000);}
}

function loadTopics(themeID) {
    fetch('/api/rotors/topics?theme_id='+themeID).then(r=>r.json()).then(topics => {
        var el = document.getElementById('topicList-'+themeID);
        var isDraft = currentRotor && currentRotor.Status === 'draft';
        var isActive = currentRotor && currentRotor.Status === 'active';
        var html = '<table style="width:100%;border-collapse:collapse;font-size:0.9rem;"><tbody>';

        if (topics && topics.length > 0) {
            topics.forEach((tp,i) => {
                html += '<tr style="border-bottom:1px solid #eee;" data-topic-id="'+tp.ID+'">';
                html += '<td style="padding:0.25rem 0.5rem;width:1.5rem;color:#6c757d;font-size:0.8rem;">'+(i+1)+'</td>';
                if (isDraft) {
                    html += '<td style="padding:0.25rem 0.25rem;"><input type="text" value="'+tp.Name.replace(/"/g,'&quot;')+'" maxlength="100" '
                        + 'onblur="autoSaveTopic(\''+tp.ID+'\',\''+themeID+'\',\'name\',this.value)" '
                        + 'onkeydown="if(event.key===\'Enter\'){this.blur();}" '
                        + 'style="width:100%;padding:0.25rem 0.4rem;border:1px solid transparent;border-radius:3px;font-size:0.9rem;font-weight:600;background:transparent;" '
                        + 'onfocus="this.style.borderColor=\'#ccc\';this.style.background=\'#fff\'" '
                        + 'onblur="this.style.borderColor=\'transparent\';this.style.background=\'transparent\';autoSaveTopic(\''+tp.ID+'\',\''+themeID+'\',\'name\',this.value)"></td>';
                    html += '<td style="padding:0.25rem 0.25rem;width:4rem;"><div style="display:flex;align-items:center;gap:0.15rem;">'
                        + '<input type="number" value="'+tp.DurationWeeks+'" min="1" max="8" '
                        + 'onblur="autoSaveTopic(\''+tp.ID+'\',\''+themeID+'\',\'duration_weeks\',this.value)" '
                        + 'onkeydown="if(event.key===\'Enter\'){this.blur();}" '
                        + 'style="width:2.5rem;padding:0.25rem;border:1px solid transparent;border-radius:3px;font-size:0.85rem;text-align:center;background:transparent;" '
                        + 'onfocus="this.style.borderColor=\'#ccc\';this.style.background=\'#fff\'" '
                        + 'onblur="this.style.borderColor=\'transparent\';this.style.background=\'transparent\';autoSaveTopic(\''+tp.ID+'\',\''+themeID+'\',\'duration_weeks\',this.value)">'
                        + '<span style="font-size:0.75rem;color:#6c757d;">wk</span></div></td>';
                } else {
                    html += '<td style="padding:0.25rem 0.5rem;font-weight:600;">'+tp.Name+'</td>';
                    html += '<td style="padding:0.25rem 0.5rem;color:#6c757d;width:3rem;">'+tp.DurationWeeks+'w</td>';
                }
                html += '<td style="padding:0.25rem 0.25rem;width:1.5rem;"><span id="status-'+tp.ID+'" style="font-size:0.75rem;"></span></td>';
                if (isActive) {
                    html += '<td style="padding:0.25rem 0.25rem;text-align:right;width:3rem;">';
                    html += '<button onclick="scheduleAction(\'activate\',\''+tp.ID+'\',\''+themeID+'\')" style="padding:0.1rem 0.4rem;font-size:0.7rem;background:#28a745;">Start</button>';
                    html += '</td>';
                }
                if (isDraft) {
                    html += '<td style="padding:0.25rem 0.25rem;text-align:right;width:1.5rem;"><button onclick="deleteTopic(\''+tp.ID+'\',\''+themeID+'\')" style="background:#dc3545;padding:0.1rem 0.3rem;font-size:0.7rem;line-height:1;">×</button></td>';
                }
                html += '</tr>';
            });
        }

        if (isDraft) {
            html += '<tr id="newTopicRow-'+themeID+'" style="border-bottom:1px solid #eee;">';
            html += '<td style="padding:0.25rem 0.5rem;color:#6c757d;font-size:0.8rem;">+</td>';
            html += '<td colspan="3" style="padding:0.25rem 0.25rem;"><input type="text" id="newTopic-'+themeID+'" placeholder="Type topic name, press Enter" maxlength="100" '
                + 'onkeydown="if(event.key===\'Enter\'){addTopic(\''+themeID+'\');}" '
                + 'style="width:100%;padding:0.25rem 0.4rem;border:1px solid #ccc;border-radius:3px;font-size:0.9rem;"></td>';
            html += '<td><span id="themeTopicErr-'+themeID+'" style="font-size:0.75rem;"></span></td>';
            html += '</tr>';
        }

        html += '</tbody></table>';

        if (isActive) {
            html += '<div id="schedControls-'+themeID+'" style="margin-top:0.5rem;"></div>';
        }
        el.innerHTML = html;

        if (isActive) {
            loadScheduleControls(themeID);
        }
    });
}

function loadScheduleControls(themeID) {
    fetch('/api/curriculum/view?class_type_id='+currentClassID).then(r=>r.json()).then(data => {
        if (!data.themes) return;
        var theme = data.themes.find(t => t.ID === themeID);
        if (!theme || !theme.active_schedule) return;
        var ctrl = document.getElementById('schedControls-'+themeID);
        if (!ctrl) return;
        var sched = theme.active_schedule;
        var activeTopic = theme.topics.find(t => t.is_active);
        var name = activeTopic ? activeTopic.Name : 'Unknown';
        ctrl.innerHTML = '<div style="background:#e8f5e9;padding:0.5rem;border-radius:4px;font-size:0.85rem;">' +
            '<strong>Active:</strong> '+name+' (until '+new Date(sched.EndDate).toLocaleDateString()+') ' +
            '<button onclick="scheduleAction(\'extend\',\'\',\''+themeID+'\')" style="padding:0.1rem 0.4rem;font-size:0.75rem;">Extend</button> ' +
            '<button onclick="scheduleAction(\'skip\',\'\',\''+themeID+'\')" style="padding:0.1rem 0.4rem;font-size:0.75rem;background:#F9B232;">Skip</button> ' +
            '<button onclick="scheduleAction(\'complete\',\'\',\''+themeID+'\')" style="padding:0.1rem 0.4rem;font-size:0.75rem;background:#dc3545;">Complete</button>' +
            '</div>';
    });
}

function deleteTopic(id, themeID) {
    fetch('/api/rotors/topics?id='+id,{method:'DELETE',headers:{'Content-Type':'application/json'}}).then(()=>loadTopics(themeID));
}

function scheduleAction(action, topicID, themeID) {
    var body = {action:action, rotor_theme_id:themeID};
    if (topicID) body.topic_id = topicID;
    if (action === 'extend') body.extend_weeks = 1;
    fetch('/api/rotors/schedule/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
        .then(r=>{if(!r.ok) throw r; return r.json();})
        .then(()=>loadTopics(themeID));
}

loadClassTypes();
</script>
{{ end }}
