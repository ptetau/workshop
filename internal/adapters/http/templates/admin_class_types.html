{{ define "content" }}
<div class="card">
    <h1>Class Type Management</h1>

    <div id="createForm" style="background: #f8f9fa; padding: 1.5rem; border-radius:2px; margin-bottom: 2rem;">
        <h3 style="margin-top:0;">Add Class Type</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label>Program</label>
                <select id="programID" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="name" maxlength="200" placeholder="e.g. Gi Express">
            </div>
            <div class="form-group">
                <label>Attire</label>
                <select id="attire" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
                    <option value="">(none)</option>
                    <option value="gi">Gi</option>
                    <option value="nogi">No-Gi</option>
                    <option value="both">Gi or No-Gi</option>
                </select>
            </div>
            <div class="form-group">
                <label>Level</label>
                <input type="text" id="level" maxlength="100" placeholder="e.g. Beginner, All-levels">
            </div>
            <div class="form-group" style="grid-column:1/-1;">
                <label>Description</label>
                <textarea id="description" rows="3" maxlength="2000" placeholder="Optional. Shown in the timetable UI later."></textarea>
            </div>
        </div>
        <button onclick="createClassType()" style="margin-top:0.5rem;">Add Class Type</button>
        <span id="formMsg" style="margin-left:1rem;color:#F9B232;"></span>
    </div>

    <h2>Current Class Types</h2>
    <table id="ctTable" style="width:100%;border-collapse:collapse;">
        <thead>
            <tr style="background:#f8f9fa;border-bottom:2px solid #dee2e6;">
                <th style="padding:0.5rem;text-align:left;">Program</th>
                <th style="padding:0.5rem;text-align:left;">Name</th>
                <th style="padding:0.5rem;text-align:left;">Attire</th>
                <th style="padding:0.5rem;text-align:left;">Level</th>
                <th style="padding:0.5rem;text-align:left;">Description</th>
                <th style="padding:0.5rem;text-align:right;">Actions</th>
            </tr>
        </thead>
        <tbody id="ctBody">
            <tr><td colspan="6" style="padding:1rem;color:#6c757d;text-align:center;">Loading...</td></tr>
        </tbody>
    </table>

    <p style="margin-top:2rem;"><a href="/dashboard" style="color:#F9B232;text-decoration:none;font-weight:600;">‚Üê Back to Dashboard</a></p>
</div>

<div id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:9001;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:4px;padding:2rem;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.2);position:relative;">
        <h3 style="margin-top:0;">Edit Class Type</h3>
        <div style="margin-bottom:0.75rem;color:#6c757d;font-size:0.85rem;">Program: <strong id="editProgramName"></strong></div>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="editName" maxlength="200">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
            <div class="form-group">
                <label>Attire</label>
                <select id="editAttire" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
                    <option value="">(none)</option>
                    <option value="gi">Gi</option>
                    <option value="nogi">No-Gi</option>
                    <option value="both">Gi or No-Gi</option>
                </select>
            </div>
            <div class="form-group">
                <label>Level</label>
                <input type="text" id="editLevel" maxlength="100">
            </div>
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea id="editDescription" rows="3" maxlength="2000"></textarea>
        </div>
        <div style="display:flex;gap:0.5rem;align-items:center;">
            <button onclick="saveEdit()">Save</button>
            <button onclick="cancelEdit()" style="background:#6c757d;">Cancel</button>
            <span id="editMsg" style="margin-left:0.5rem;font-size:0.85rem;"></span>
        </div>
    </div>
</div>

<script>
var programs = [];
var classTypes = [];

function programName(id) {
    var p = programs.find(x => x.ID === id);
    return p ? p.Name : id;
}

function loadPrograms() {
    return fetch('/api/programs').then(r => r.json()).then(data => {
        programs = data || [];
        var sel = document.getElementById('programID');
        sel.innerHTML = '<option value="">Select program</option>';
        programs.forEach(p => {
            sel.innerHTML += '<option value="' + p.ID + '">' + p.Name + '</option>';
        });
    });
}

function loadClassTypes() {
    return fetch('/api/class-types').then(r => r.json()).then(data => {
        classTypes = data || [];
        drawTable();
    });
}

function drawTable() {
    var body = document.getElementById('ctBody');
    if (!classTypes || classTypes.length === 0) {
        body.innerHTML = '<tr><td colspan="6" style="padding:1rem;color:#6c757d;text-align:center;">No class types yet.</td></tr>';
        return;
    }
    body.innerHTML = '';
    classTypes.forEach(ct => {
        body.innerHTML += '<tr style="border-bottom:1px solid #dee2e6;">' +
            '<td style="padding:0.5rem;">' + escHtml(programName(ct.ProgramID)) + '</td>' +
            '<td style="padding:0.5rem;font-weight:600;">' + escHtml(ct.Name) + '</td>' +
            '<td style="padding:0.5rem;">' + escHtml(ct.Attire || '') + '</td>' +
            '<td style="padding:0.5rem;">' + escHtml(ct.Level || '') + '</td>' +
            '<td style="padding:0.5rem;color:#6c757d;font-size:0.9rem;">' + escHtml((ct.Description || '').slice(0, 120)) + '</td>' +
            '<td style="padding:0.5rem;text-align:right;">' +
                '<button onclick="editClassType(\'' + ct.ID + '\')" style="background:#6c757d;padding:0.25rem 0.75rem;font-size:0.85rem;">Edit</button> ' +
                '<button onclick="deleteClassType(\'' + ct.ID + '\')" style="background:#dc3545;padding:0.25rem 0.75rem;font-size:0.85rem;">Delete</button>' +
            '</td>' +
        '</tr>';
    });
}

function createClassType() {
    var body = {
        ProgramID: document.getElementById('programID').value,
        Name: document.getElementById('name').value,
        Description: document.getElementById('description').value,
        Attire: document.getElementById('attire').value,
        Level: document.getElementById('level').value
    };
    fetch('/api/class-types', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) })
        .then(r => { if (!r.ok) throw r; return r.json(); })
        .then(() => {
            document.getElementById('formMsg').textContent = 'Created!';
            document.getElementById('name').value = '';
            document.getElementById('description').value = '';
            document.getElementById('attire').value = '';
            document.getElementById('level').value = '';
            loadClassTypes();
            setTimeout(() => document.getElementById('formMsg').textContent = '', 2000);
        })
        .catch(() => document.getElementById('formMsg').textContent = 'Error creating class type');
}

var editingID = null;
function editClassType(id) {
    var ct = classTypes.find(x => x.ID === id);
    if (!ct) return;
    editingID = id;
    document.getElementById('editName').value = ct.Name || '';
    document.getElementById('editLevel').value = ct.Level || '';
    document.getElementById('editAttire').value = ct.Attire || '';
    document.getElementById('editDescription').value = ct.Description || '';
    document.getElementById('editProgramName').textContent = programName(ct.ProgramID);
    document.getElementById('editMsg').textContent = '';
    document.getElementById('editModal').style.display = 'flex';
}
function cancelEdit() {
    editingID = null;
    document.getElementById('editModal').style.display = 'none';
}
function saveEdit() {
    var ct = classTypes.find(x => x.ID === editingID);
    if (!ct) return;
    var body = {
        ID: ct.ID,
        ProgramID: ct.ProgramID,
        Name: document.getElementById('editName').value,
        Description: document.getElementById('editDescription').value,
        Attire: document.getElementById('editAttire').value,
        Level: document.getElementById('editLevel').value
    };
    fetch('/api/class-types', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) })
        .then(r => { if (!r.ok) throw r; return r.json(); })
        .then(() => { cancelEdit(); loadClassTypes(); })
        .catch(() => { document.getElementById('editMsg').textContent = 'Error saving'; document.getElementById('editMsg').style.color = '#dc3545'; });
}

function deleteClassType(id) {
    if (!confirm('Delete this class type? Schedules using it may break.')) return;
    fetch('/api/class-types?id=' + encodeURIComponent(id), { method: 'DELETE', headers: {'Content-Type': 'application/json'} })
        .then(r => { if (!r.ok) throw r; })
        .then(() => loadClassTypes())
        .catch(() => alert('Error deleting class type (it may be in use by schedules).'));
}

function escHtml(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

loadPrograms().then(loadClassTypes);
</script>
{{ end }}
