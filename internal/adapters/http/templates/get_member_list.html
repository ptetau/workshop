{{ define "content" }}
<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
        <h1>üìã Member List</h1>
        <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
            {{ if or (eq (currentRole) "admin") (eq (currentRole) "coach") }}
            <a id="export-members-csv" href="/api/members/export?{{ exportMembersQuery .Sort .Dir .Search .Program .Status }}" style="background:#1f2937;color:white;padding:0.5rem 1.1rem;text-decoration:none;font-weight:600;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px;border-radius:2px;">Export CSV</a>
            {{ end }}
            {{ if eq (currentRole) "admin" }}
            <button id="import-csv-btn" type="button" onclick="document.getElementById('import-csv-modal').style.display='flex'" style="background:#1f2937;color:white;padding:0.5rem 1.1rem;border:none;font-weight:600;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px;border-radius:2px;cursor:pointer;">Import CSV</button>
            {{ end }}
            <a href="/members/register" style="background:var(--orange);color:white;padding:0.5rem 1.25rem;text-decoration:none;font-weight:600;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.5px;border-radius:2px;">+ Register Member</a>
        </div>
    </div>

    <!-- Search and Filter Controls -->
    <form method="GET" action="/members" id="list-form" style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end; margin-bottom: 1.5rem;">
        <!-- Preserve sort params -->
        {{ if .Sort }}<input type="hidden" name="sort" value="{{ .Sort }}">{{ end }}
        {{ if .Dir }}<input type="hidden" name="dir" value="{{ .Dir }}">{{ end }}

        <div style="flex: 1; min-width: 200px;">
            <label for="search-input" style="font-size: 0.8rem;">Search</label>
            <input type="text" id="search-input" name="q" value="{{ .Search }}" placeholder="Search by name or email..." maxlength="100" style="width: 100%;">
        </div>
        <div style="min-width: 140px;">
            <label for="program-filter" style="font-size: 0.8rem;">Program</label>
            <select id="program-filter" name="program" onchange="document.getElementById('list-form').submit()">
                <option value="">All Programs</option>
                <option value="Adults"{{ if eq .Program "Adults" }} selected{{ end }}>Adults</option>
                <option value="Kids"{{ if eq .Program "Kids" }} selected{{ end }}>Kids</option>
            </select>
        </div>
        <div style="min-width: 140px;">
            <label for="status-filter" style="font-size: 0.8rem;">Status</label>
            <select id="status-filter" name="status" onchange="document.getElementById('list-form').submit()">
                <option value="">All Statuses</option>
                <option value="active"{{ if eq .Status "active" }} selected{{ end }}>Active</option>
                <option value="trial"{{ if eq .Status "trial" }} selected{{ end }}>Trial</option>
                <option value="archived"{{ if eq .Status "archived" }} selected{{ end }}>Archived</option>
            </select>
        </div>
        <div style="min-width: 120px;">
            <label for="per-page-select" style="font-size: 0.8rem;">Rows</label>
            <select id="per-page-select" name="per_page" onchange="document.getElementById('list-form').submit()">
                {{ $currentPerPage := .PageInfo.PerPage }}
                {{ range .PerPageOptions }}
                <option value="{{ . }}"{{ if eq . $currentPerPage }} selected{{ end }}>{{ . }}</option>
                {{ end }}
            </select>
        </div>
        <button type="submit" style="padding: 0.6rem 1.2rem;">Search</button>
        {{ if .HasFilters }}
        <a href="/members" id="clear-filters" style="padding: 0.6rem 1.2rem; background: #6c757d; color: white; text-decoration: none; border-radius: 2px; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; display: inline-block;">Clear</a>
        {{ end }}
    </form>

    <!-- Results Summary -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; color: #6c757d; font-size: 0.85rem;">
        <span id="results-summary">
            {{ if .Members }}
            Showing {{ .PageInfo.StartRow }}-{{ .PageInfo.EndRow }} of {{ .PageInfo.Total }} results
            {{ else }}
            No results found
            {{ end }}
        </span>
    </div>

    {{ if .Members }}
    <table style="width: 100%; border-collapse: collapse; margin: 0 0 1rem 0;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                {{ template "sort-header" (sortHeaderArgs "name" "Name" $.Sort $.Dir $.Search $.Program $.Status $.PageInfo.PerPage) }}
                {{ template "sort-header" (sortHeaderArgs "email" "Email" $.Sort $.Dir $.Search $.Program $.Status $.PageInfo.PerPage) }}
                {{ template "sort-header" (sortHeaderArgs "program" "Program" $.Sort $.Dir $.Search $.Program $.Status $.PageInfo.PerPage) }}
                {{ template "sort-header" (sortHeaderArgs "status" "Status" $.Sort $.Dir $.Search $.Program $.Status $.PageInfo.PerPage) }}
                <th style="padding: 0.75rem; text-align: center;">Injury</th>
            </tr>
        </thead>
        <tbody>
            {{ range .Members }}
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 0.75rem;">
                    <div style="display:flex;align-items:center;gap:0.5rem;min-width:0;">
                        <span class="belt-inline" aria-hidden="true">
                            <span class="belt-icon {{ if .Belt }}belt-{{ .Belt }}{{ else }}belt-none{{ end }}"></span>
                            {{ if and .Belt (gt .Stripe 0) }}
                                {{ range $i := .Stripe | stripeRange }}<span class="stripe-dot"></span>{{ end }}
                            {{ end }}
                        </span>
                        <a href="/members/profile?id={{ .ID }}" style="color: #667eea; text-decoration: none; font-weight: 600; overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ .Name }}</a>
                    </div>
                </td>
                <td style="padding: 0.75rem;">{{ .Email }}</td>
                <td style="padding: 0.75rem;">
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: #e3f2fd; color: #1976d2;">
                        {{ .Program }}
                    </span>
                </td>
                <td style="padding: 0.75rem; text-align: center;">
                    {{ if eq .Status "active" }}
                    <span style="color: #F9B232; font-weight: 600;">‚úì Active</span>
                    {{ else if eq .Status "trial" }}
                    <span style="color: #17a2b8; font-weight: 600;">‚óÜ Trial</span>
                    {{ else }}
                    <span style="color: #dc3545; font-weight: 600;">‚úó Archived</span>
                    {{ end }}
                </td>
                <td style="padding: 0.75rem; text-align: center;">
                    {{ if .HasInjury }}
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; background: #fff3cd; color: #856404; font-weight: 600;">
                        üö® {{ .InjuryBodyPart }}
                    </span>
                    {{ else }}
                    <span style="color: #6c757d;">‚Äî</span>
                    {{ end }}
                </td>
            </tr>
            {{ end }}
        </tbody>
    </table>

    <!-- Pagination Controls -->
    {{ if .PageInfo.ShowPagination }}
    <nav style="display: flex; justify-content: center; align-items: center; gap: 0.25rem; margin-top: 1rem;" aria-label="Pagination">
        {{ $pi := .PageInfo }}
        {{ if gt $pi.Page 1 }}
        <a href="/members?{{ paginationQuery 1 $.Sort $.Dir $.Search $.Program $.Status $pi.PerPage }}" style="padding: 0.4rem 0.7rem; border: 1px solid var(--border); border-radius: 2px; text-decoration: none; color: var(--text); font-size: 0.85rem;">First</a>
        <a href="/members?{{ paginationQuery (sub $pi.Page 1) $.Sort $.Dir $.Search $.Program $.Status $pi.PerPage }}" style="padding: 0.4rem 0.7rem; border: 1px solid var(--border); border-radius: 2px; text-decoration: none; color: var(--text); font-size: 0.85rem;">Previous</a>
        {{ end }}

        {{ range $pi.PageNumbers }}
        {{ if eq . $pi.Page }}
        <span style="padding: 0.4rem 0.7rem; border: 1px solid var(--orange); border-radius: 2px; background: var(--orange); color: white; font-size: 0.85rem; font-weight: 600;">{{ . }}</span>
        {{ else }}
        <a href="/members?{{ paginationQuery . $.Sort $.Dir $.Search $.Program $.Status $pi.PerPage }}" style="padding: 0.4rem 0.7rem; border: 1px solid var(--border); border-radius: 2px; text-decoration: none; color: var(--text); font-size: 0.85rem;">{{ . }}</a>
        {{ end }}
        {{ end }}

        {{ if lt $pi.Page $pi.TotalPages }}
        <a href="/members?{{ paginationQuery (add $pi.Page 1) $.Sort $.Dir $.Search $.Program $.Status $pi.PerPage }}" style="padding: 0.4rem 0.7rem; border: 1px solid var(--border); border-radius: 2px; text-decoration: none; color: var(--text); font-size: 0.85rem;">Next</a>
        <a href="/members?{{ paginationQuery $pi.TotalPages $.Sort $.Dir $.Search $.Program $.Status $pi.PerPage }}" style="padding: 0.4rem 0.7rem; border: 1px solid var(--border); border-radius: 2px; text-decoration: none; color: var(--text); font-size: 0.85rem;">Last</a>
        {{ end }}
    </nav>
    {{ end }}

    {{ else }}
    <p style="color: #6c757d; font-style: italic; padding: 2rem; text-align: center; background: #f8f9fa; border-radius:2px;">
        {{ if .HasFilters }}
        No members match your filters. <a href="/members" style="color: #F9B232; text-decoration: underline;">Clear filters</a>
        {{ else }}
        No members registered yet. <a href="/members/register" style="color: #F9B232; text-decoration: underline;">Register a new member</a>
        {{ end }}
    </p>
    {{ end }}

    <p style="margin-top: 2rem;">
        <a href="/dashboard" style="color: #F9B232; text-decoration: none; font-weight: 600;">‚Üê Back to Dashboard</a>
    </p>
</div>

{{ if eq (currentRole) "admin" }}
<!-- Import CSV Modal -->
<div id="import-csv-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;border-radius:4px;padding:2rem;max-width:520px;width:100%;margin:1rem;max-height:90vh;overflow-y:auto;">
        <h2 style="margin:0 0 1rem;font-size:1.1rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;">Import Members from CSV</h2>

        <!-- Step 1: Upload -->
        <div id="import-step-upload">
            <p style="font-size:0.85rem;color:#6c757d;margin-bottom:1rem;">
                Required columns: <strong>NAME, EMAIL</strong><br>
                Optional: PROGRAM, STATUS, FEE, FREQUENCY, GRADINGMETRIC<br>
                Unknown columns are ignored.
            </p>
            <input type="hidden" id="import-csrf-token" value="{{ csrfToken }}">
            <div style="margin-bottom:1rem;">
                <label style="font-size:0.85rem;font-weight:600;">CSV File</label>
                <input type="file" id="import-file-input" accept=".csv,text/csv" style="display:block;margin-top:0.4rem;width:100%;">
            </div>
            <div style="margin-bottom:1.5rem;">
                <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.85rem;cursor:pointer;">
                    <input type="checkbox" id="import-update-mode">
                    <span><strong>Update existing members</strong> (match by email ‚Äî preserves ID)</span>
                </label>
                <p style="font-size:0.8rem;color:#6c757d;margin:0.25rem 0 0 1.5rem;">Default: skip rows where email already exists.</p>
            </div>
            <div id="import-upload-error" style="display:none;color:#dc3545;font-size:0.85rem;margin-bottom:1rem;"></div>
            <div style="display:flex;gap:0.75rem;justify-content:flex-end;">
                <button type="button" onclick="closeImportModal()" style="background:#6c757d;color:white;border:none;padding:0.5rem 1.25rem;border-radius:2px;cursor:pointer;font-size:0.85rem;">Cancel</button>
                <button type="button" id="import-preview-btn" onclick="previewImport()" style="background:var(--orange);color:white;border:none;padding:0.5rem 1.25rem;border-radius:2px;cursor:pointer;font-size:0.85rem;font-weight:600;">Preview</button>
            </div>
        </div>

        <!-- Step 2: Preview -->
        <div id="import-step-preview" style="display:none;">
            <div id="import-preview-summary" style="background:#f8f9fa;border-radius:2px;padding:1rem;margin-bottom:1rem;font-size:0.9rem;"></div>
            <div id="import-preview-errors" style="display:none;margin-bottom:1rem;"></div>
            <div id="import-unknown-cols" style="display:none;color:#856404;background:#fff3cd;padding:0.75rem;border-radius:2px;font-size:0.8rem;margin-bottom:1rem;"></div>
            <div style="display:flex;gap:0.75rem;justify-content:flex-end;">
                <button type="button" onclick="resetImportModal()" style="background:#6c757d;color:white;border:none;padding:0.5rem 1.25rem;border-radius:2px;cursor:pointer;font-size:0.85rem;">Back</button>
                <button type="button" id="import-confirm-btn" onclick="confirmImport()" style="background:var(--orange);color:white;border:none;padding:0.5rem 1.25rem;border-radius:2px;cursor:pointer;font-size:0.85rem;font-weight:600;">Confirm Import</button>
            </div>
        </div>

        <!-- Step 3: Done -->
        <div id="import-step-done" style="display:none;">
            <div id="import-done-summary" style="background:#d4edda;border-radius:2px;padding:1rem;margin-bottom:1rem;font-size:0.9rem;color:#155724;"></div>
            <div style="display:flex;gap:0.75rem;justify-content:flex-end;">
                <button type="button" onclick="closeImportModal();window.location.reload();" style="background:var(--orange);color:white;border:none;padding:0.5rem 1.25rem;border-radius:2px;cursor:pointer;font-size:0.85rem;font-weight:600;">Done</button>
            </div>
        </div>
    </div>
</div>

<script>
var _importFile = null;
var _importUpdateMode = false;

function closeImportModal() {
    document.getElementById('import-csv-modal').style.display = 'none';
    resetImportModal();
}
function resetImportModal() {
    document.getElementById('import-step-upload').style.display = '';
    document.getElementById('import-step-preview').style.display = 'none';
    document.getElementById('import-step-done').style.display = 'none';
    document.getElementById('import-upload-error').style.display = 'none';
    document.getElementById('import-file-input').value = '';
}
function previewImport() {
    var fileInput = document.getElementById('import-file-input');
    if (!fileInput.files || !fileInput.files[0]) {
        showImportError('Please select a CSV file.');
        return;
    }
    _importFile = fileInput.files[0];
    _importUpdateMode = document.getElementById('import-update-mode').checked;
    var btn = document.getElementById('import-preview-btn');
    btn.disabled = true; btn.textContent = 'Previewing‚Ä¶';
    postImport(true, function(result) {
        btn.disabled = false; btn.textContent = 'Preview';
        if (!result) return;
        showPreview(result);
    });
}
function confirmImport() {
    var btn = document.getElementById('import-confirm-btn');
    btn.disabled = true; btn.textContent = 'Importing‚Ä¶';
    postImport(false, function(result) {
        btn.disabled = false; btn.textContent = 'Confirm Import';
        if (!result) return;
        document.getElementById('import-step-preview').style.display = 'none';
        document.getElementById('import-step-done').style.display = '';
        var s = result;
        document.getElementById('import-done-summary').innerHTML =
            '<strong>Import complete.</strong><br>' +
            'Created: ' + s.created + ' &nbsp; Updated: ' + s.updated +
            ' &nbsp; Skipped: ' + s.skipped + ' &nbsp; Errors: ' + (s.errors ? s.errors.length : 0);
    });
}
function postImport(dryRun, cb) {
    var fd = new FormData();
    fd.append('file', _importFile);
    var csrfInput = document.getElementById('import-csrf-token');
    if (csrfInput) { fd.append('gorilla.csrf.Token', csrfInput.value); }
    var url = '/api/members/import?dry_run=' + (dryRun ? 'true' : 'false') +
              (_importUpdateMode ? '&update_mode=true' : '');
    fetch(url, {
        method: 'POST',
        body: fd
    }).then(function(resp) {
        if (!resp.ok) {
            return resp.text().then(function(t) { showImportError(t); cb(null); });
        }
        return resp.json().then(cb);
    }).catch(function(e) { showImportError(e.toString()); cb(null); });
}
function showPreview(r) {
    document.getElementById('import-step-upload').style.display = 'none';
    document.getElementById('import-step-preview').style.display = '';
    document.getElementById('import-preview-summary').innerHTML =
        '<strong>Preview</strong><br>' +
        'Total rows: ' + r.total + '<br>' +
        'Will create: <strong>' + r.created + '</strong><br>' +
        'Will update: <strong>' + r.updated + '</strong><br>' +
        'Will skip (duplicate email): <strong>' + r.skipped + '</strong><br>' +
        'Errors: <strong>' + (r.errors ? r.errors.length : 0) + '</strong>';
    var errDiv = document.getElementById('import-preview-errors');
    if (r.errors && r.errors.length > 0) {
        var html = '<p style="font-size:0.85rem;font-weight:600;color:#dc3545;margin:0 0 0.5rem;">Row errors (will be skipped):</p><ul style="margin:0;padding-left:1.25rem;font-size:0.8rem;color:#dc3545;">';
        r.errors.forEach(function(e) { html += '<li>Row ' + e.row + ': ' + e.message + '</li>'; });
        html += '</ul>';
        errDiv.innerHTML = html; errDiv.style.display = '';
    } else { errDiv.style.display = 'none'; }
    var unkDiv = document.getElementById('import-unknown-cols');
    if (r.unknown_columns && r.unknown_columns.length > 0) {
        unkDiv.textContent = 'Unknown columns (ignored): ' + r.unknown_columns.join(', ');
        unkDiv.style.display = '';
    } else { unkDiv.style.display = 'none'; }
    if (r.created === 0 && r.updated === 0) {
        document.getElementById('import-confirm-btn').disabled = true;
    }
}
function showImportError(msg) {
    var el = document.getElementById('import-upload-error');
    el.textContent = msg; el.style.display = '';
}
</script>
{{ end }}

<script>
// Debounce search input (250ms)
(function() {
    var input = document.getElementById('search-input');
    var timer;
    input.addEventListener('input', function() {
        clearTimeout(timer);
        timer = setTimeout(function() {
            document.getElementById('list-form').submit();
        }, 250);
    });
    // Persist per_page in localStorage
    var perPageSelect = document.getElementById('per-page-select');
    var saved = localStorage.getItem('list_per_page');
    if (saved && !new URLSearchParams(window.location.search).has('per_page')) {
        perPageSelect.value = saved;
    }
    perPageSelect.addEventListener('change', function() {
        localStorage.setItem('list_per_page', this.value);
    });
})();
</script>
{{ end }}

{{ define "sort-header" }}
<th style="padding: 0.75rem; text-align: left;">
    <a href="/members?sort={{ .Col }}&dir={{ .NextDir }}{{ if .Search }}&q={{ .Search }}{{ end }}{{ if .Program }}&program={{ .Program }}{{ end }}{{ if .Status }}&status={{ .Status }}{{ end }}{{ if .PerPage }}&per_page={{ .PerPage }}{{ end }}"
       style="color: var(--dark); text-decoration: none; display: inline-flex; align-items: center; gap: 0.3rem; font-weight: 600; font-size: 0.85rem;">
        {{ .Label }}
        {{ if eq .Col .ActiveSort }}
            {{ if eq .ActiveDir "asc" }}‚ñ≤{{ else }}‚ñº{{ end }}
        {{ end }}
    </a>
</th>
{{ end }}