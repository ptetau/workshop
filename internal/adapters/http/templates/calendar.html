{{ define "content" }}
<div class="card">
    <h1>Club Calendar</h1>

    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;">
        <button onclick="prevMonth()" style="padding:0.3rem 0.6rem;font-size:1rem;">‚Üê</button>
        <h2 id="monthTitle" style="margin:0;min-width:180px;text-align:center;"></h2>
        <button onclick="nextMonth()" style="padding:0.3rem 0.6rem;font-size:1rem;">‚Üí</button>
        <button onclick="goToday()" style="padding:0.25rem 0.6rem;font-size:0.85rem;margin-left:0.5rem;">Today</button>
        <button onclick="toggleRotors()" id="rotorToggleBtn" style="padding:0.25rem 0.6rem;font-size:0.85rem;">Show Rotors</button>
        <button onclick="toggleGoals()" id="goalsToggleBtn" style="padding:0.25rem 0.6rem;font-size:0.85rem;">Goals</button>
        {{ if eq (currentRole) "admin" }}
        <button onclick="showAddEvent()" style="padding:0.25rem 0.6rem;font-size:0.85rem;margin-left:auto;">+ Event</button>
        {{ end }}
    </div>

    <div id="goalsPanel" style="display:none;background:#f8f9fa;padding:1rem;border-radius:4px;margin-bottom:1rem;border:1px solid #dee2e6;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
            <h4 style="margin:0;">Personal Goals</h4>
            <button onclick="showAddGoal()" style="padding:0.25rem 0.6rem;font-size:0.8rem;background:#28a745;color:#fff;border:none;border-radius:3px;cursor:pointer;">+ Add Goal</button>
        </div>
        <div id="addGoalForm" style="display:none;background:#fff;padding:0.75rem;border-radius:3px;border:1px solid #dee2e6;margin-bottom:0.75rem;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
                <div style="grid-column:1/-1;">
                    <input type="text" id="goalTitle" placeholder="Goal title (e.g., 50 rear naked strangles)" style="width:100%;padding:0.3rem;border:1px solid #ccc;border-radius:3px;font-size:0.85rem;">
                </div>
                <div>
                    <input type="number" id="goalTarget" placeholder="Target (e.g., 50)" style="width:100%;padding:0.3rem;border:1px solid #ccc;border-radius:3px;font-size:0.85rem;">
                </div>
                <div>
                    <select id="goalType" style="width:100%;padding:0.3rem;border:1px solid #ccc;border-radius:3px;font-size:0.85rem;" onchange="onGoalTypeChange()">
                        <option value="manual">Manual tracking</option>
                        <option value="hours">Auto-track hours</option>
                    </select>
                </div>
                <div>
                    <input type="date" id="goalStart" style="width:100%;padding:0.3rem;border:1px solid #ccc;border-radius:3px;font-size:0.85rem;">
                </div>
                <div>
                    <input type="date" id="goalEnd" style="width:100%;padding:0.3rem;border:1px solid #ccc;border-radius:3px;font-size:0.85rem;">
                </div>
                <div style="grid-column:1/-1;display:flex;gap:0.5rem;align-items:center;">
                    <button onclick="saveGoal()" style="padding:0.2rem 0.6rem;font-size:0.8rem;">Save</button>
                    <button onclick="hideAddGoal()" style="padding:0.2rem 0.6rem;font-size:0.8rem;background:#6c757d;">Cancel</button>
                    <span id="goalErr" style="color:#dc3545;font-size:0.8rem;"></span>
                </div>
            </div>
        </div>
        <div id="goalsContent">Loading...</div>
    </div>

    <div id="addEventForm" style="display:none;background:#f8f9fa;padding:1rem;border-radius:4px;margin-bottom:1rem;border:1px solid #dee2e6;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem 1rem;max-width:600px;">
            <div style="grid-column:1/-1;">
                <label style="font-size:0.85rem;font-weight:600;">Title</label>
                <input type="text" id="eventTitle" maxlength="200" placeholder="e.g. End of Year BBQ" style="width:100%;padding:0.4rem;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div>
                <label style="font-size:0.85rem;font-weight:600;">Type</label>
                <select id="eventType" style="width:100%;padding:0.4rem;border:1px solid #ccc;border-radius:4px;">
                    <option value="event">Club Event</option>
                    <option value="competition">Competition</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.85rem;font-weight:600;">Location</label>
                <input type="text" id="eventLocation" maxlength="200" placeholder="e.g. Workshop HQ" style="width:100%;padding:0.4rem;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div>
                <label style="font-size:0.85rem;font-weight:600;">Start Date</label>
                <input type="date" id="eventStart" style="width:100%;padding:0.4rem;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div>
                <label style="font-size:0.85rem;font-weight:600;">End Date <span style="color:#6c757d;font-weight:400;">(optional)</span></label>
                <input type="date" id="eventEnd" style="width:100%;padding:0.4rem;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div id="regUrlRow" style="grid-column:1/-1;display:none;">
                <label style="font-size:0.85rem;font-weight:600;">Registration URL</label>
                <input type="url" id="eventRegURL" maxlength="2048" placeholder="https://..." style="width:100%;padding:0.4rem;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div style="grid-column:1/-1;">
                <label style="font-size:0.85rem;font-weight:600;">Description <span style="color:#6c757d;font-weight:400;">(optional)</span></label>
                <textarea id="eventDesc" maxlength="2000" rows="2" style="width:100%;padding:0.4rem;border:1px solid #ccc;border-radius:4px;resize:vertical;"></textarea>
            </div>
            <div style="grid-column:1/-1;display:flex;gap:0.5rem;align-items:center;">
                <button onclick="saveEvent()" style="padding:0.3rem 0.8rem;">Save</button>
                <button onclick="hideAddEvent()" style="background:#6c757d;padding:0.3rem 0.8rem;">Cancel</button>
                <span id="eventErr" style="color:#dc3545;font-size:0.85rem;"></span>
            </div>
        </div>
    </div>

    <div style="overflow-x:auto;">
        <table id="calGrid" style="width:100%;border-collapse:collapse;table-layout:fixed;">
            <thead>
                <tr>
                    <th style="padding:0.4rem;text-align:center;font-size:0.85rem;color:#6c757d;border-bottom:2px solid #dee2e6;">Mon</th>
                    <th style="padding:0.4rem;text-align:center;font-size:0.85rem;color:#6c757d;border-bottom:2px solid #dee2e6;">Tue</th>
                    <th style="padding:0.4rem;text-align:center;font-size:0.85rem;color:#6c757d;border-bottom:2px solid #dee2e6;">Wed</th>
                    <th style="padding:0.4rem;text-align:center;font-size:0.85rem;color:#6c757d;border-bottom:2px solid #dee2e6;">Thu</th>
                    <th style="padding:0.4rem;text-align:center;font-size:0.85rem;color:#6c757d;border-bottom:2px solid #dee2e6;">Fri</th>
                    <th style="padding:0.4rem;text-align:center;font-size:0.85rem;color:#6c757d;border-bottom:2px solid #dee2e6;">Sat</th>
                    <th style="padding:0.4rem;text-align:center;font-size:0.85rem;color:#6c757d;border-bottom:2px solid #dee2e6;">Sun</th>
                </tr>
            </thead>
            <tbody id="calBody"></tbody>
        </table>
    </div>

    <div id="eventList" style="margin-top:1.5rem;"></div>

    <p style="margin-top:2rem;"><a href="/dashboard" style="color:#F9B232;text-decoration:none;font-weight:600;">‚Üê Back to Dashboard</a></p>
</div>

<script>
var isAdmin = (document.body && (document.body.getAttribute('data-role') || '')) === 'admin';
var currentYear, currentMonth;
var calEvents = [];

function init() {
    var now = new Date();
    currentYear = now.getFullYear();
    currentMonth = now.getMonth();
    document.getElementById('eventType').addEventListener('change', function() {
        document.getElementById('regUrlRow').style.display = this.value === 'competition' ? 'block' : 'none';
    });
    // Set default dates for goal form
    var firstDay = new Date(currentYear, currentMonth, 1);
    var lastDay = new Date(currentYear, currentMonth + 1, 0);
    document.getElementById('goalStart').value = formatDate(firstDay);
    document.getElementById('goalEnd').value = formatDate(lastDay);
    renderMonth();
    loadGoals();
}

function prevMonth() {
    currentMonth--;
    if (currentMonth < 0) { currentMonth = 11; currentYear--; }
    renderMonth();
}
function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
    renderMonth();
}
function goToday() {
    var now = new Date();
    currentYear = now.getFullYear();
    currentMonth = now.getMonth();
    renderMonth();
}

function renderMonth() {
    var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    document.getElementById('monthTitle').textContent = months[currentMonth] + ' ' + currentYear;

    var firstDay = new Date(currentYear, currentMonth, 1);
    var lastDay = new Date(currentYear, currentMonth + 1, 0);
    var startDow = (firstDay.getDay() + 6) % 7;

    var from = new Date(firstDay);
    from.setDate(from.getDate() - startDow);
    var to = new Date(lastDay);
    var endDow = (to.getDay() + 6) % 7;
    to.setDate(to.getDate() + (6 - endDow));

    var fromStr = formatDate(from);
    var toStr = formatDate(to);

    fetch('/api/calendar/events?from=' + fromStr + '&to=' + toStr)
        .then(function(r) { return r.json(); })
        .then(function(events) {
            calEvents = events || [];
            drawGrid(from, lastDay.getDate(), startDow);
            drawEventList();
        });
}

function drawGrid(startDate, daysInMonth, startDow) {
    var today = new Date();
    var todayStr = formatDate(today);
    var body = document.getElementById('calBody');
    var html = '';
    var d = new Date(startDate);
    var totalCells = startDow + daysInMonth;
    var rows = Math.ceil(totalCells / 7);

    for (var row = 0; row < rows; row++) {
        html += '<tr>';
        for (var col = 0; col < 7; col++) {
            var dateStr = formatDate(d);
            var isCurrentMonth = d.getMonth() === currentMonth;
            var isToday = dateStr === todayStr;
            var dayEvents = calEvents.filter(function(e) {
                var eStart = e.StartDate ? e.StartDate.substring(0, 10) : '';
                var eEnd = e.EndDate ? e.EndDate.substring(0, 10) : eStart;
                if (eEnd === '' || eEnd === '0001-01-01') eEnd = eStart;
                return dateStr >= eStart && dateStr <= eEnd;
            });

            var bg = isToday ? '#FFF8E1' : (isCurrentMonth ? '#fff' : '#f8f9fa');
            var color = isCurrentMonth ? '#212529' : '#adb5bd';
            html += '<td style="padding:0.25rem;border:1px solid #eee;vertical-align:top;height:5rem;background:' + bg + ';">';
            html += '<div style="font-size:0.8rem;font-weight:' + (isToday ? '700' : '400') + ';color:' + color + ';">' + d.getDate() + '</div>';

            dayEvents.forEach(function(ev) {
                var evColor = ev.Type === 'competition' ? '#dc3545' : '#F9B232';
                html += '<div style="font-size:0.7rem;padding:0.1rem 0.2rem;margin-top:0.1rem;background:' + evColor + ';color:#fff;border-radius:2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;cursor:pointer;" title="' + escHtml(ev.Title) + '">';
                html += escHtml(ev.Title);
                html += '</div>';
            });

            // Add rotor topics overlay
            var rotorTopics = getRotorTopicsForDate(dateStr);
            rotorTopics.forEach(function(topic) {
                html += '<div style="font-size:0.65rem;padding:0.1rem 0.2rem;margin-top:0.1rem;background:' + topic.color + ';color:#fff;border-radius:2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;cursor:pointer;opacity:0.9;" title="' + escHtml(topic.classType + ' - ' + topic.themeName) + '">';
                html += escHtml(topic.name);
                html += '</div>';
            });

            // Add personal goals overlay
            var dayGoals = getGoalsForDate(dateStr);
            dayGoals.forEach(function(goal) {
                var pct = Math.round((goal.progress / goal.target) * 100);
                if (pct > 100) pct = 100;
                html += '<div style="font-size:0.6rem;padding:0.1rem 0.2rem;margin-top:0.1rem;background:' + (goal.color || '#F9B232') + ';color:#fff;border-radius:2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;cursor:pointer;" title="' + escHtml(goal.title + ' (' + goal.progress + '/' + goal.target + ')') + '">';
                html += '<div style="display:flex;align-items:center;gap:0.2rem;">';
                html += '<span>' + escHtml(goal.title.substring(0, 15)) + '</span>';
                html += '<span style="opacity:0.8;">(' + goal.progress + '/' + goal.target + ')</span>';
                html += '</div>';
                html += '</div>';
            });

            html += '</td>';
            d.setDate(d.getDate() + 1);
        }
        html += '</tr>';
    }
    body.innerHTML = html;
}

function drawEventList() {
    var el = document.getElementById('eventList');
    var upcoming = calEvents.filter(function(e) {
        var eStart = e.StartDate ? e.StartDate.substring(0, 10) : '';
        return eStart >= formatDate(new Date(currentYear, currentMonth, 1));
    });
    upcoming.sort(function(a, b) {
        return (a.StartDate || '').localeCompare(b.StartDate || '');
    });

    if (upcoming.length === 0) {
        el.innerHTML = '<p style="color:#6c757d;">No events this month.</p>';
        return;
    }

    var html = '<h3 style="margin-bottom:0.5rem;">Events This Month</h3>';
    upcoming.forEach(function(ev) {
        var startStr = ev.StartDate ? ev.StartDate.substring(0, 10) : '';
        var endStr = (ev.EndDate && ev.EndDate.substring(0, 10) !== '0001-01-01') ? ev.EndDate.substring(0, 10) : '';
        var typeLabel = ev.Type === 'competition'
            ? '<span style="background:#dc3545;color:#fff;font-size:0.7rem;padding:0.1rem 0.3rem;border-radius:3px;margin-left:0.5rem;">Competition</span>'
            : '<span style="background:#F9B232;color:#fff;font-size:0.7rem;padding:0.1rem 0.3rem;border-radius:3px;margin-left:0.5rem;">Event</span>';

        html += '<div style="border:1px solid #dee2e6;border-radius:4px;padding:0.75rem;margin-bottom:0.5rem;" data-event-id="' + ev.ID + '">';
        html += '<div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">';
        html += '<strong>' + escHtml(ev.Title) + '</strong>' + typeLabel;
        html += '<span style="color:#6c757d;font-size:0.85rem;margin-left:auto;">' + startStr;
        if (endStr && endStr !== startStr) html += ' ‚Üí ' + endStr;
        html += '</span>';
        if (isAdmin) {
            html += '<button onclick="deleteEvent(\'' + ev.ID + '\')" style="background:#dc3545;padding:0.1rem 0.4rem;font-size:0.7rem;">√ó</button>';
        }
        html += '</div>';
        if (ev.Location) html += '<div style="font-size:0.85rem;color:#6c757d;margin-top:0.25rem;">üìç ' + escHtml(ev.Location) + '</div>';
        if (ev.Description) html += '<div style="font-size:0.85rem;margin-top:0.25rem;">' + escHtml(ev.Description) + '</div>';
        if (ev.Type === 'competition') {
            html += '<div style="margin-top:0.5rem;display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">';
            html += '<button onclick="toggleInterest(\'' + ev.ID + '\')" id="interest-btn-' + ev.ID + '" style="padding:0.2rem 0.6rem;font-size:0.8rem;background:#28a745;color:#fff;border:none;border-radius:3px;cursor:pointer;">Interested</button>';
            html += '<span id="interest-count-' + ev.ID + '" style="font-size:0.8rem;color:#6c757d;"></span>';
            if (ev.RegistrationURL) {
                html += '<a href="' + escHtml(ev.RegistrationURL) + '" target="_blank" style="padding:0.2rem 0.6rem;font-size:0.8rem;background:#F9B232;color:#fff;border-radius:3px;text-decoration:none;">Register ‚Üí</a>';
            }
            html += '</div>';
        } else if (ev.RegistrationURL) {
            html += '<div style="margin-top:0.25rem;"><a href="' + escHtml(ev.RegistrationURL) + '" target="_blank" style="color:#F9B232;font-size:0.85rem;">Register ‚Üí</a></div>';
        }
        html += '</div>';
    });
    el.innerHTML = html;
    // Load interest counts for competitions
    upcoming.forEach(function(ev) {
        if (ev.Type === 'competition') {
            loadInterestCount(ev.ID);
        }
    });
}

function showAddEvent() {
    document.getElementById('addEventForm').style.display = 'block';
    document.getElementById('eventTitle').value = '';
    document.getElementById('eventType').value = 'event';
    document.getElementById('eventLocation').value = '';
    document.getElementById('eventStart').value = '';
    document.getElementById('eventEnd').value = '';
    document.getElementById('eventRegURL').value = '';
    document.getElementById('eventDesc').value = '';
    document.getElementById('eventErr').textContent = '';
    document.getElementById('regUrlRow').style.display = 'none';
    document.getElementById('eventTitle').focus();
}
function hideAddEvent() { document.getElementById('addEventForm').style.display = 'none'; }

function saveEvent() {
    var title = document.getElementById('eventTitle').value.trim();
    if (!title) { document.getElementById('eventErr').textContent = 'Title required'; return; }
    var startDate = document.getElementById('eventStart').value;
    if (!startDate) { document.getElementById('eventErr').textContent = 'Start date required'; return; }
    document.getElementById('eventErr').textContent = '';

    var body = {
        title: title,
        type: document.getElementById('eventType').value,
        description: document.getElementById('eventDesc').value.trim(),
        location: document.getElementById('eventLocation').value.trim(),
        start_date: startDate,
        end_date: document.getElementById('eventEnd').value || '',
        registration_url: document.getElementById('eventRegURL').value.trim()
    };

    fetch('/api/calendar/events', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
    })
    .then(function(r) { if (!r.ok) return r.text().then(function(t) { throw new Error(t); }); return r.json(); })
    .then(function() { hideAddEvent(); renderMonth(); })
    .catch(function(e) { document.getElementById('eventErr').textContent = e.message; });
}

function deleteEvent(id) {
    if (!confirm('Delete this event?')) return;
    fetch('/api/calendar/events?id=' + id, {method: 'DELETE', headers: {'Content-Type': 'application/json'}})
        .then(function() { renderMonth(); });
}

function toggleInterest(eventID) {
    var btn = document.getElementById('interest-btn-' + eventID);
    if (!btn) return;

    var isInterested = btn.textContent === 'Not Going';
    if (isInterested) {
        // Unregister interest
        fetch('/api/calendar/interest?event_id=' + eventID, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        }).then(function(r) {
            if (r.ok) {
                btn.textContent = 'Interested';
                btn.style.background = '#28a745';
                loadInterestCount(eventID);
            }
        });
    } else {
        // Register interest
        fetch('/api/calendar/interest', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({event_id: eventID})
        }).then(function(r) {
            if (r.ok) {
                btn.textContent = 'Not Going';
                btn.style.background = '#6c757d';
                loadInterestCount(eventID);
            }
        });
    }
}

function loadInterestCount(eventID) {
    var span = document.getElementById('interest-count-' + eventID);
    if (!span) return;
    fetch('/api/calendar/interest?event_id=' + eventID)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var count = data ? data.length : 0;
            span.textContent = count + ' going';
        })
        .catch(function() {
            span.textContent = '';
        });
}

function formatDate(d) {
    var y = d.getFullYear();
    var m = ('0' + (d.getMonth() + 1)).slice(-2);
    var day = ('0' + d.getDate()).slice(-2);
    return y + '-' + m + '-' + day;
}

function escHtml(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

var rotorsVisible = false;
var rotorData = [];
var selectedRotors = new Set();
var rotorColors = ['#F9B232', '#28a745', '#dc3545', '#6f42c1', '#17a2b8'];

function toggleRotors() {
    rotorsVisible = !rotorsVisible;
    var panel = document.getElementById('rotorPanel');
    var btn = document.getElementById('rotorToggleBtn');
    panel.style.display = rotorsVisible ? 'block' : 'none';
    btn.textContent = rotorsVisible ? 'Hide Rotors' : 'Show Rotors';
    if (rotorsVisible && rotorData.length === 0) {
        loadRotors();
    }
}

function loadRotors() {
    var content = document.getElementById('rotorContent');
    content.textContent = 'Loading...';
    fetch('/api/calendar/rotors')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            rotorData = data || [];
            // Select all by default
            rotorData.forEach(function(r, i) {
                selectedRotors.add(r.rotor_id);
            });
            renderRotors();
            renderMonth(); // Re-render calendar with rotor overlay
        })
        .catch(function() {
            content.textContent = 'Failed to load rotors.';
        });
}

function toggleRotorSelection(rotorId) {
    if (selectedRotors.has(rotorId)) {
        selectedRotors.delete(rotorId);
    } else {
        selectedRotors.add(rotorId);
    }
    renderRotors();
    renderMonth(); // Re-render calendar with updated overlay
}

function renderRotors() {
    var content = document.getElementById('rotorContent');
    if (rotorData.length === 0) {
        content.innerHTML = '<p style="color:#6c757d;margin:0;">No active rotors.</p>';
        return;
    }
    var html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">';
    html += '<span style="font-size:0.85rem;color:#6c757d;">Select rotors to overlay:</span>';
    html += '<div style="display:flex;gap:0.5rem;">';
    html += '<button onclick="selectAllRotors()" style="padding:0.2rem 0.5rem;font-size:0.75rem;background:#6c757d;color:#fff;border:none;border-radius:3px;cursor:pointer;">All</button>';
    html += '<button onclick="clearAllRotors()" style="padding:0.2rem 0.5rem;font-size:0.75rem;background:#e9ecef;color:#495057;border:none;border-radius:3px;cursor:pointer;">None</button>';
    html += '</div></div>';
    rotorData.forEach(function(rotor, index) {
        var color = rotorColors[index % rotorColors.length];
        var isSelected = selectedRotors.has(rotor.rotor_id);
        html += '<div style="margin-bottom:0.5rem;padding:0.5rem;background:#fff;border-radius:3px;border:1px solid ' + (isSelected ? color : '#e9ecef') + ';border-left:4px solid ' + color + ';">';
        html += '<label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">';
        html += '<input type="checkbox" ' + (isSelected ? 'checked' : '') + ' onchange="toggleRotorSelection(\'' + rotor.rotor_id + '\')">';
        html += '<span style="font-weight:600;">' + escHtml(rotor.class_type_name) + '</span>';
        html += '</label>';
        if (isSelected) {
            rotor.themes.forEach(function(theme) {
                html += '<div style="margin-top:0.4rem;padding-left:1rem;font-size:0.8rem;">';
                html += '<span style="color:#6c757d;">' + escHtml(theme.theme_name) + ':</span> ';
                html += escHtml(theme.current.topic_name);
                if (theme.next) {
                    html += ' ‚Üí ' + escHtml(theme.next.topic_name);
                }
                html += '</div>';
            });
        }
        html += '</div>';
    });
    content.innerHTML = html;
}

function selectAllRotors() {
    rotorData.forEach(function(r) {
        selectedRotors.add(r.rotor_id);
    });
    renderRotors();
    renderMonth();
}

function clearAllRotors() {
    selectedRotors.clear();
    renderRotors();
    renderMonth();
}

// Get rotor topic for a specific date
function getRotorTopicsForDate(dateStr) {
    var topics = [];
    rotorData.forEach(function(rotor, rotorIndex) {
        if (!selectedRotors.has(rotor.rotor_id)) return;
        var color = rotorColors[rotorIndex % rotorColors.length];
        rotor.themes.forEach(function(theme) {
            // Check current topic
            if (dateStr >= theme.current.start_date && dateStr <= theme.current.end_date) {
                topics.push({
                    name: theme.current.topic_name,
                    themeName: theme.theme_name,
                    color: color,
                    classType: rotor.class_type_name
                });
            }
            // Check next topic
            if (theme.next && dateStr >= theme.next.start_date && dateStr <= theme.next.end_date) {
                topics.push({
                    name: theme.next.topic_name,
                    themeName: theme.theme_name,
                    color: color,
                    classType: rotor.class_type_name
                });
            }
        });
    });
    return topics;
}

// --- Personal Goals ---
var goalsVisible = false;
var goalsData = [];

function toggleGoals() {
    goalsVisible = !goalsVisible;
    var panel = document.getElementById('goalsPanel');
    var btn = document.getElementById('goalsToggleBtn');
    panel.style.display = goalsVisible ? 'block' : 'none';
    btn.textContent = goalsVisible ? 'Hide Goals' : 'Goals';
    if (goalsVisible) {
        loadGoals();
    }
}

function showAddGoal() {
    document.getElementById('addGoalForm').style.display = 'block';
    document.getElementById('goalTitle').value = '';
    document.getElementById('goalTarget').value = '';
    document.getElementById('goalUnit').value = '';
    var firstDay = new Date(currentYear, currentMonth, 1);
    var lastDay = new Date(currentYear, currentMonth + 1, 0);
    document.getElementById('goalStart').value = formatDate(firstDay);
    document.getElementById('goalEnd').value = formatDate(lastDay);
    document.getElementById('goalErr').textContent = '';
    document.getElementById('goalTitle').focus();
}

function hideAddGoal() {
    document.getElementById('addGoalForm').style.display = 'none';
}

function onGoalTypeChange() {
    var type = document.getElementById('goalType').value;
    var unitInput = document.getElementById('goalUnit');
    if (type === 'hours') {
        unitInput.value = 'hours';
        unitInput.disabled = true;
    } else {
        unitInput.value = '';
        unitInput.disabled = false;
    }
}

function saveGoal() {
    var title = document.getElementById('goalTitle').value.trim();
    var target = parseInt(document.getElementById('goalTarget').value, 10);
    var type = document.getElementById('goalType').value;
    var unit = type === 'hours' ? 'hours' : document.getElementById('goalUnit').value.trim();
    var startDate = document.getElementById('goalStart').value;
    var endDate = document.getElementById('goalEnd').value;

    if (!title) { document.getElementById('goalErr').textContent = 'Title required'; return; }
    if (!target || target <= 0) { document.getElementById('goalErr').textContent = 'Valid target required'; return; }
    if (!unit) { document.getElementById('goalErr').textContent = 'Unit required'; return; }
    if (!startDate || !endDate) { document.getElementById('goalErr').textContent = 'Start and end dates required'; return; }

    document.getElementById('goalErr').textContent = '';

    var body = {
        title: title,
        target: target,
        unit: unit,
        type: type,
        start_date: startDate,
        end_date: endDate,
        progress: 0
    };

    fetch('/api/personal-goals', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
    })
    .then(function(r) { if (!r.ok) return r.text().then(function(t) { throw new Error(t); }); return r.json(); })
    .then(function() {
        hideAddGoal();
        loadGoals();
        renderMonth();
    })
    .catch(function(e) { document.getElementById('goalErr').textContent = e.message; });
}

function loadGoals() {
    var content = document.getElementById('goalsContent');
    content.textContent = 'Loading...';
    fetch('/api/personal-goals')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            goalsData = data || [];
            renderGoals();
            renderMonth();
        })
        .catch(function() {
            content.textContent = 'Failed to load goals.';
        });
}

function renderGoals() {
    var content = document.getElementById('goalsContent');
    if (goalsData.length === 0) {
        content.innerHTML = '<p style="color:#6c757d;margin:0;">No personal goals yet. Add one to track your progress!</p>';
        return;
    }
    var html = '';
    goalsData.forEach(function(goal) {
        var pct = Math.round((goal.progress / goal.target) * 100);
        if (pct > 100) pct = 100;
        var isAutoTracked = goal.type === 'hours';
        var autoBadge = isAutoTracked ? '<span style="font-size:0.7rem;background:#17a2b8;color:#fff;padding:0.1rem 0.3rem;border-radius:3px;margin-left:0.3rem;">auto</span>' : '';
        html += '<div style="margin-bottom:0.75rem;padding:0.5rem;background:#fff;border-radius:3px;border:1px solid #e9ecef;">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
        html += '<div style="display:flex;align-items:center;"><strong style="font-size:0.9rem;">' + escHtml(goal.title) + '</strong>' + autoBadge + '</div>';
        html += '<span style="font-size:0.8rem;color:#6c757d;">' + goal.progress + '/' + goal.target + ' ' + escHtml(goal.unit) + '</span>';
        html += '</div>';
        html += '<div style="margin-top:0.5rem;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden;">';
        html += '<div style="height:100%;width:' + pct + '%;background:' + (goal.color || '#F9B232') + ';transition:width 0.3s;"></div>';
        html += '</div>';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem;">';
        html += '<span style="font-size:0.75rem;color:#6c757d;">' + goal.start_date + ' ‚Üí ' + goal.end_date + '</span>';
        html += '<div style="display:flex;gap:0.3rem;">';
        if (!isAutoTracked) {
            html += '<button onclick="updateGoalProgress(\'' + goal.id + '\', ' + (goal.progress - 1) + ')" style="padding:0.1rem 0.4rem;font-size:0.75rem;background:#e9ecef;border:none;border-radius:3px;cursor:pointer;">-</button>';
            html += '<button onclick="updateGoalProgress(\'' + goal.id + '\', ' + (goal.progress + 1) + ')" style="padding:0.1rem 0.4rem;font-size:0.75rem;background:#28a745;color:#fff;border:none;border-radius:3px;cursor:pointer;">+</button>';
        }
        html += '<button onclick="deleteGoal(\'' + goal.id + '\')" style="padding:0.1rem 0.4rem;font-size:0.75rem;background:#dc3545;color:#fff;border:none;border-radius:3px;cursor:pointer;">√ó</button>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    content.innerHTML = html;
}

function updateGoalProgress(goalId, newProgress) {
    if (newProgress < 0) newProgress = 0;
    fetch('/api/personal-goals/progress', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id: goalId, progress: newProgress})
    })
    .then(function(r) { return r.json(); })
    .then(function() {
        loadGoals();
    });
}

function deleteGoal(goalId) {
    if (!confirm('Delete this goal?')) return;
    fetch('/api/personal-goals?id=' + goalId, {method: 'DELETE'})
        .then(function() { loadGoals(); renderMonth(); });
}

// Get active goals for a specific date
function getGoalsForDate(dateStr) {
    return goalsData.filter(function(goal) {
        return dateStr >= goal.start_date && dateStr <= goal.end_date;
    });
}

init();
</script>
{{ end }}
