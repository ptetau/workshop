#!/bin/sh
#
# Pre-commit hook â€” runs the same checks as CI before allowing a commit.
# Install: git config core.hooksPath .githooks
#
set -e

echo "=== pre-commit: go mod tidy check ==="
mod_hash_before=$(tr -d '\r' < go.mod | sha256sum)
sum_hash_before=$(tr -d '\r' < go.sum | sha256sum)
go mod tidy
mod_hash_after=$(tr -d '\r' < go.mod | sha256sum)
sum_hash_after=$(tr -d '\r' < go.sum | sha256sum)
if [ "$mod_hash_before" != "$mod_hash_after" ] || [ "$sum_hash_before" != "$sum_hash_after" ]; then
  echo "FAIL: go.mod or go.sum changed after 'go mod tidy'. Stage the changes and retry."
  exit 1
fi

echo "=== pre-commit: build ==="
go build ./...

echo "=== pre-commit: vet ==="
go vet ./...

echo "=== pre-commit: gofmt check ==="
unformatted=$(gofmt -l .)
if [ -n "$unformatted" ]; then
  echo "FAIL: the following files are not formatted:"
  echo "$unformatted"
  echo "Run: gofmt -w ."
  exit 1
fi

echo "=== pre-commit: tests ==="
go test -count=1 ./...

echo "=== pre-commit: lintguidelines ==="
go run ./tools/lintguidelines --root . --strict

echo ""
echo "All pre-commit checks passed."
